<!doctype html>
<html lang="zh">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>实现迷你SSR - 组件服务端渲染</title>
    <script type="module" crossorigin src="/21081715/dist/assets/index-MQVGeJDe.js"></script>
    <script type="module" crossorigin src="/21081715/dist/assets/index-A_9H3jJA.js"></script>
    <link rel="stylesheet" crossorigin href="/21081715/dist/assets/index-FnwD_uIS.css">
    <link rel="stylesheet" crossorigin href="/21081715/dist/assets/index-FJxq1wWu.css">
  </head>
  <body class="flex flex-col h-100vh overflow-hidden">
    <header-bar></header-bar>

    <div class="pt-4 flex flex-col flex-1 overflow-auto scrollbar-slim gap-4">
      <div class="flex">
        <aside class="hidden lg:block basis-72 pl-2">
          <h2 class="text-lg">最新评论</h2>

          <div class="flex gap-2 items-start">
            <!-- <div class="pa-1 bg-lime-2 border-1 border-solid rounded-full">
              <i class="i-uil-0-plus text-lg"></i>
            </div>
            <p class="my-0 bg-primary-2 dark:bg-primary-7 rounded-lg pa-2">
              Lorem ipsum dolor sit amet consectetur adipisicing elit. Ut eius repellendus molestiae
              quia?
            </p> -->
          </div>
        </aside>
        <main class="md:mx-4 flex-1 rounded-xl overflow-hidden">
          <header>
            <h1 class="text-center">Title实现迷你SSR - 组件服务端渲染</h1>
          </header>
          <article
            class="markdown-article bg-primary-2 pa-4 rounded-xl dark:bg-primary-7 line-height-6"
          >
            <p class="paragraph"><img src="https://img.shields.io/badge/docs-%F0%9F%90%A4_%E8%AF%AD%E9%9B%80-%2328BE5E#from=url&id=Gz3J1&originHeight=20&originWidth=82&originalType=binary&ratio=1.25&rotation=0&showTitle=false&status=done&style=none&title=" alt=""></p><p class="paragraph">由于<code class="inline-code">Nuxtjs</code>等元框架的使用，一直好奇于<code class="inline-code">SSR</code>的实现原理，所以决定使用最少的依赖（排雷：无<del>Express</del>，了解<code class="inline-code">h</code>函数的使用）尝试实现一下<code class="inline-code">Vue3</code>的服务端渲染。<br /><code class="inline-code">Node.js 21.1.0</code>更新了<code class="inline-code">ESM</code>的判断规则，可以直接引入<code class="inline-code">ESM</code>而不需要添加烦人的<code class="inline-code">.js</code>后缀了(手里的<code class="inline-code">Node 20</code>才用几天就不香了)，若使用<code class="inline-code">Node.js 21+</code>下文的<code class="inline-code">entry-server.js</code>可以尝试修改一下实现不打包而直接运行了并且可以使用 node 自带的 <code class="inline-code">watch</code> 命令，前提是不使用 SFC 。</p><ul>
<li><code class="inline-code">Node.js &gt;= 18.0.0</code>(支持<code class="inline-code">fetch API</code>)</li>
<li><code class="inline-code">Vue &gt;= 3.2</code></li>
<li><code class="inline-code">VueRouter &gt;= 4.0</code></li>
<li><code class="inline-code">Pinia &gt;= 2.0</code>
<a name="qhqMG"></a></li>
</ul>

          <h2 id="%E7%9B%AE%E6%A0%87%E6%B8%85%E5%8D%95" class="header h2">
            <a name="目标清单" data-level="2" class="anchor" href="#%E7%9B%AE%E6%A0%87%E6%B8%85%E5%8D%95">
              <span class="header-link">#</span>
            </a>
            目标清单
          </h2><ul>
<li>✅ <a href="https://github.com/Jon-a-than/vue3-ssr-mini/tree/v0.0.1" title="null" class="link">组件渲染</a></li>
<li>✅ <a href="https://github.com/Jon-a-than/vue3-ssr-mini/tree/v0.0.2" title="null" class="link">路由功能</a></li>
<li>✅ <a href="https://github.com/Jon-a-than/vue3-ssr-mini/tree/v0.0.3" title="null" class="link">状态管理</a></li>
<li>✅ 数据预取</li>
<li>🚧 部分预渲染
<a name="g0xKM"></a></li>
</ul>

          <h2 id="%E4%BE%9D%E8%B5%96" class="header h2">
            <a name="依赖" data-level="2" class="anchor" href="#%E4%BE%9D%E8%B5%96">
              <span class="header-link">#</span>
            </a>
            依赖
          </h2><p class="paragraph"><code class="inline-code">Vue3</code>服务端渲染最重要的依赖是<code class="inline-code">vue</code>与<code class="inline-code">@vue/server-renderer</code>,<code class="inline-code">@vue/server-renderer</code>用于将组件在服务端渲染为<code class="inline-code">html</code>字符串，从而拼接到<code class="inline-code">html</code>中，不过<code class="inline-code">@vue/server-renderer</code>已经在<code class="inline-code">vue</code>包中内置了所以不必单独安装 :p。</p><pre><code class="language-bash"><pre class="shiki material-theme" style="background-color: #263238" tabindex="0"><code><span class="line"><span style="color: #FFCB6B">pnpm</span><span style="color: #EEFFFF"> </span><span style="color: #C3E88D">i</span><span style="color: #EEFFFF"> </span><span style="color: #C3E88D">vue</span><span style="color: #EEFFFF"> </span><span style="color: #C3E88D">-P</span></span></code></pre>
</code></pre><p class="paragraph"><a name="dVRRD"></a></p>
          <h2 id="Node.js%E6%B8%B2%E6%9F%93Vue%E7%BB%84%E4%BB%B6" class="header h2">
            <a name="Node.js渲染Vue组件" data-level="2" class="anchor" href="#Node.js%E6%B8%B2%E6%9F%93Vue%E7%BB%84%E4%BB%B6">
              <span class="header-link">#</span>
            </a>
            Node.js渲染Vue组件
          </h2><p class="paragraph"><a name="gOCmA"></a></p>
          <h3 id="%E7%BB%84%E4%BB%B6%E6%B8%B2%E6%9F%93" class="header h3">
            <a name="组件渲染" data-level="3" class="anchor" href="#%E7%BB%84%E4%BB%B6%E6%B8%B2%E6%9F%93">
              <span class="header-link">#</span>
            </a>
            组件渲染
          </h3><p class="paragraph">既然要最简实现，所以使用<code class="inline-code">h</code>函数来创建<code class="inline-code">Vue</code>组件而并不是单文件组件。<br />先创建<code class="inline-code">entry-server.js</code>(该文件名已成约定)来看看<code class="inline-code">renderToString</code>这个函数的功能。</p><pre><code class="language-javascript"><pre class="shiki material-theme" style="background-color: #263238" tabindex="0"><code><span class="line"><span style="color: #89DDFF; font-style: italic">import</span><span style="color: #EEFFFF"> </span><span style="color: #89DDFF">{</span><span style="color: #F07178"> </span><span style="color: #EEFFFF">h</span><span style="color: #F07178"> </span><span style="color: #89DDFF">}</span><span style="color: #EEFFFF"> </span><span style="color: #89DDFF; font-style: italic">from</span><span style="color: #EEFFFF"> </span><span style="color: #89DDFF">&#39;</span><span style="color: #C3E88D">vue</span><span style="color: #89DDFF">&#39;</span></span>
<span class="line"><span style="color: #89DDFF; font-style: italic">import</span><span style="color: #EEFFFF"> </span><span style="color: #89DDFF">{</span><span style="color: #F07178"> </span><span style="color: #EEFFFF">renderToString</span><span style="color: #F07178"> </span><span style="color: #89DDFF">}</span><span style="color: #EEFFFF"> </span><span style="color: #89DDFF; font-style: italic">from</span><span style="color: #EEFFFF"> </span><span style="color: #89DDFF">&#39;</span><span style="color: #C3E88D">vue/server-renderer</span><span style="color: #89DDFF">&#39;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C792EA">const</span><span style="color: #EEFFFF"> app </span><span style="color: #89DDFF">=</span><span style="color: #EEFFFF"> </span><span style="color: #82AAFF">h</span><span style="color: #EEFFFF">(</span><span style="color: #89DDFF">&#39;</span><span style="color: #C3E88D">h1</span><span style="color: #89DDFF">&#39;</span><span style="color: #89DDFF">,</span><span style="color: #EEFFFF"> </span><span style="color: #89DDFF">&#39;</span><span style="color: #C3E88D">Hello world!</span><span style="color: #89DDFF">&#39;</span><span style="color: #EEFFFF">)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C792EA">const</span><span style="color: #EEFFFF"> AppString </span><span style="color: #89DDFF">=</span><span style="color: #EEFFFF"> </span><span style="color: #89DDFF; font-style: italic">await</span><span style="color: #EEFFFF"> </span><span style="color: #82AAFF">renderToString</span><span style="color: #EEFFFF">(app)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #EEFFFF">console</span><span style="color: #89DDFF">.</span><span style="color: #82AAFF">log</span><span style="color: #EEFFFF">(AppString) </span><span style="color: #546E7A; font-style: italic">// &lt;h1&gt;Hello World!&lt;/h1&gt;</span></span></code></pre>
</code></pre><p class="paragraph"><code class="inline-code">package.json</code>编写一下运行脚本, 执行<code class="inline-code">pnpm dev:server</code>即可看到<code class="inline-code">&lt;h1&gt;Hello World!&lt;/h1&gt;</code>的结果。这么神奇! 那我们把字符串插入到<code class="inline-code">HTML</code>模板中岂不就完成了服务端渲染，页面静态生成好像也是一步之遥。</p><pre><code class="language-json"><pre class="shiki material-theme" style="background-color: #263238" tabindex="0"><code><span class="line"><span style="color: #89DDFF">{</span></span>
<span class="line"><span style="color: #EEFFFF">  </span><span style="color: #89DDFF">&quot;</span><span style="color: #C792EA">type</span><span style="color: #89DDFF">&quot;</span><span style="color: #89DDFF">:</span><span style="color: #EEFFFF"> </span><span style="color: #89DDFF">&quot;</span><span style="color: #C3E88D">module</span><span style="color: #89DDFF">&quot;</span><span style="color: #89DDFF">,</span></span>
<span class="line"><span style="color: #EEFFFF">  </span><span style="color: #89DDFF">&quot;</span><span style="color: #C792EA">scripts</span><span style="color: #89DDFF">&quot;</span><span style="color: #89DDFF">:</span><span style="color: #EEFFFF"> </span><span style="color: #89DDFF">{</span></span>
<span class="line"><span style="color: #EEFFFF">    </span><span style="color: #89DDFF">&quot;</span><span style="color: #FFCB6B">dev:server</span><span style="color: #89DDFF">&quot;</span><span style="color: #89DDFF">:</span><span style="color: #EEFFFF"> </span><span style="color: #89DDFF">&quot;</span><span style="color: #C3E88D">node ./src/entry-server.js</span><span style="color: #89DDFF">&quot;</span></span>
<span class="line"><span style="color: #EEFFFF">  </span><span style="color: #89DDFF">},</span></span>
<span class="line"><span style="color: #EEFFFF">  </span><span style="color: #89DDFF">&quot;</span><span style="color: #C792EA">dependencies</span><span style="color: #89DDFF">&quot;</span><span style="color: #89DDFF">:</span><span style="color: #EEFFFF"> </span><span style="color: #89DDFF">{</span></span>
<span class="line"><span style="color: #EEFFFF">    </span><span style="color: #89DDFF">&quot;</span><span style="color: #FFCB6B">vue</span><span style="color: #89DDFF">&quot;</span><span style="color: #89DDFF">:</span><span style="color: #EEFFFF"> </span><span style="color: #89DDFF">&quot;</span><span style="color: #C3E88D">^3.3.7</span><span style="color: #89DDFF">&quot;</span></span>
<span class="line"><span style="color: #EEFFFF">  </span><span style="color: #89DDFF">}</span></span>
<span class="line"><span style="color: #89DDFF">}</span></span>
<span class="line"></span></code></pre>
</code></pre><p class="paragraph">:::success
由于使用的是<code class="inline-code">ESM</code>，要记得在<code class="inline-code">package.json</code>中添加<code class="inline-code">&quot;type&quot;: &quot;module&quot;</code>
:::</p><p class="paragraph"><a name="vhAj2"></a></p>
          <h3 id="%E6%8B%BC%E6%8E%A5HTML%E9%A1%B5%E9%9D%A2" class="header h3">
            <a name="拼接HTML页面" data-level="3" class="anchor" href="#%E6%8B%BC%E6%8E%A5HTML%E9%A1%B5%E9%9D%A2">
              <span class="header-link">#</span>
            </a>
            拼接HTML页面
          </h3><p class="paragraph">先在根目录创建一个<code class="inline-code">index.html</code>文件作为页面模板, 使用<code class="inline-code">&lt;!-- App Slot --&gt;</code>作为占位字符串，待会儿就把它替换为组件的<code class="inline-code">html</code>字符串。</p><pre><code class="language-html"><pre class="shiki material-theme" style="background-color: #263238" tabindex="0"><code><span class="line"><span style="color: #89DDFF">&lt;!</span><span style="color: #F07178">DOCTYPE</span><span style="color: #89DDFF"> </span><span style="color: #C792EA">html</span><span style="color: #89DDFF">&gt;</span></span>
<span class="line"><span style="color: #89DDFF">&lt;</span><span style="color: #F07178">html</span><span style="color: #89DDFF"> </span><span style="color: #C792EA">lang</span><span style="color: #89DDFF">=</span><span style="color: #89DDFF">&quot;</span><span style="color: #C3E88D">zh</span><span style="color: #89DDFF">&quot;</span><span style="color: #89DDFF">&gt;</span></span>
<span class="line"><span style="color: #EEFFFF">  </span><span style="color: #89DDFF">&lt;</span><span style="color: #F07178">head</span><span style="color: #89DDFF">&gt;</span></span>
<span class="line"><span style="color: #EEFFFF">    </span><span style="color: #89DDFF">&lt;</span><span style="color: #F07178">meta</span><span style="color: #89DDFF"> </span><span style="color: #C792EA">charset</span><span style="color: #89DDFF">=</span><span style="color: #89DDFF">&quot;</span><span style="color: #C3E88D">UTF-8</span><span style="color: #89DDFF">&quot;</span><span style="color: #89DDFF"> /&gt;</span></span>
<span class="line"><span style="color: #EEFFFF">    </span><span style="color: #89DDFF">&lt;</span><span style="color: #F07178">meta</span><span style="color: #89DDFF"> </span><span style="color: #C792EA">name</span><span style="color: #89DDFF">=</span><span style="color: #89DDFF">&quot;</span><span style="color: #C3E88D">viewport</span><span style="color: #89DDFF">&quot;</span><span style="color: #89DDFF"> </span><span style="color: #C792EA">content</span><span style="color: #89DDFF">=</span><span style="color: #89DDFF">&quot;</span><span style="color: #C3E88D">width=device-width, initial-scale=1.0</span><span style="color: #89DDFF">&quot;</span><span style="color: #89DDFF"> /&gt;</span></span>
<span class="line"><span style="color: #EEFFFF">    </span><span style="color: #89DDFF">&lt;</span><span style="color: #F07178">title</span><span style="color: #89DDFF">&gt;</span><span style="color: #EEFFFF">Mini SSR</span><span style="color: #89DDFF">&lt;/</span><span style="color: #F07178">title</span><span style="color: #89DDFF">&gt;</span></span>
<span class="line"><span style="color: #EEFFFF">  </span><span style="color: #89DDFF">&lt;/</span><span style="color: #F07178">head</span><span style="color: #89DDFF">&gt;</span></span>
<span class="line"><span style="color: #EEFFFF">  </span><span style="color: #89DDFF">&lt;</span><span style="color: #F07178">body</span><span style="color: #89DDFF">&gt;</span></span>
<span class="line"><span style="color: #EEFFFF">    </span><span style="color: #89DDFF">&lt;</span><span style="color: #F07178">div</span><span style="color: #89DDFF"> </span><span style="color: #C792EA">id</span><span style="color: #89DDFF">=</span><span style="color: #89DDFF">&quot;</span><span style="color: #C3E88D">app</span><span style="color: #89DDFF">&quot;</span><span style="color: #89DDFF">&gt;</span><span style="color: #546E7A; font-style: italic">&lt;!-- App Slot --&gt;</span><span style="color: #89DDFF">&lt;/</span><span style="color: #F07178">div</span><span style="color: #89DDFF">&gt;</span></span>
<span class="line"><span style="color: #EEFFFF">  </span><span style="color: #89DDFF">&lt;/</span><span style="color: #F07178">body</span><span style="color: #89DDFF">&gt;</span></span>
<span class="line"><span style="color: #89DDFF">&lt;/</span><span style="color: #F07178">html</span><span style="color: #89DDFF">&gt;</span></span>
<span class="line"></span></code></pre>
</code></pre><p class="paragraph">由于要写<code class="inline-code">node.js</code>，所以最好也安装一下<code class="inline-code">@types/node</code>以增强类型提示(非必要)。</p><pre><code class="language-bash"><pre class="shiki material-theme" style="background-color: #263238" tabindex="0"><code><span class="line"><span style="color: #FFCB6B">pnpm</span><span style="color: #EEFFFF"> </span><span style="color: #C3E88D">i</span><span style="color: #EEFFFF"> </span><span style="color: #C3E88D">@types/node</span><span style="color: #EEFFFF"> </span><span style="color: #C3E88D">-D</span></span></code></pre>
</code></pre><pre><code class="language-javascript"><pre class="shiki material-theme" style="background-color: #263238" tabindex="0"><code><span class="line"><span style="color: #89DDFF; font-style: italic">import</span><span style="color: #EEFFFF"> </span><span style="color: #89DDFF">{</span><span style="color: #F07178"> </span><span style="color: #EEFFFF">h</span><span style="color: #F07178"> </span><span style="color: #89DDFF">}</span><span style="color: #EEFFFF"> </span><span style="color: #89DDFF; font-style: italic">from</span><span style="color: #EEFFFF"> </span><span style="color: #89DDFF">&#39;</span><span style="color: #C3E88D">vue</span><span style="color: #89DDFF">&#39;</span></span>
<span class="line"><span style="color: #89DDFF; font-style: italic">import</span><span style="color: #EEFFFF"> </span><span style="color: #89DDFF">{</span><span style="color: #F07178"> </span><span style="color: #EEFFFF">renderToString</span><span style="color: #F07178"> </span><span style="color: #89DDFF">}</span><span style="color: #EEFFFF"> </span><span style="color: #89DDFF; font-style: italic">from</span><span style="color: #EEFFFF"> </span><span style="color: #89DDFF">&#39;</span><span style="color: #C3E88D">vue/server-renderer</span><span style="color: #89DDFF">&#39;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #89DDFF; font-style: italic">import</span><span style="color: #EEFFFF"> </span><span style="color: #89DDFF">{</span><span style="color: #F07178"> </span><span style="color: #EEFFFF">readFile</span><span style="color: #F07178"> </span><span style="color: #89DDFF">}</span><span style="color: #EEFFFF"> </span><span style="color: #89DDFF; font-style: italic">from</span><span style="color: #EEFFFF"> </span><span style="color: #89DDFF">&#39;</span><span style="color: #C3E88D">node:fs/promises</span><span style="color: #89DDFF">&#39;</span></span>
<span class="line"><span style="color: #89DDFF; font-style: italic">import</span><span style="color: #EEFFFF"> </span><span style="color: #89DDFF">{</span><span style="color: #F07178"> </span><span style="color: #EEFFFF">fileURLToPath</span><span style="color: #F07178"> </span><span style="color: #89DDFF">}</span><span style="color: #EEFFFF"> </span><span style="color: #89DDFF; font-style: italic">from</span><span style="color: #EEFFFF"> </span><span style="color: #89DDFF">&#39;</span><span style="color: #C3E88D">node:url</span><span style="color: #89DDFF">&#39;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C792EA">const</span><span style="color: #EEFFFF"> component </span><span style="color: #89DDFF">=</span><span style="color: #EEFFFF"> </span><span style="color: #82AAFF">h</span><span style="color: #EEFFFF">(</span><span style="color: #89DDFF">&#39;</span><span style="color: #C3E88D">h1</span><span style="color: #89DDFF">&#39;</span><span style="color: #89DDFF">,</span><span style="color: #EEFFFF"> </span><span style="color: #89DDFF">&#39;</span><span style="color: #C3E88D">Hello World!</span><span style="color: #89DDFF">&#39;</span><span style="color: #EEFFFF">)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #EEFFFF">console</span><span style="color: #89DDFF">.</span><span style="color: #82AAFF">log</span><span style="color: #EEFFFF">(</span><span style="color: #89DDFF; font-style: italic">await</span><span style="color: #EEFFFF"> </span><span style="color: #82AAFF">render</span><span style="color: #EEFFFF">(component))</span></span>
<span class="line"></span>
<span class="line"><span style="color: #546E7A; font-style: italic">/**</span></span>
<span class="line"><span style="color: #546E7A; font-style: italic"> * </span><span style="color: #89DDFF; font-style: italic">@</span><span style="color: #C792EA; font-style: italic">param</span><span style="color: #546E7A; font-style: italic"> </span><span style="color: #89DDFF; font-style: italic">{</span><span style="color: #FFCB6B; font-style: italic">import(&#39;vue&#39;).App&lt;any&gt; | import(&#39;vue&#39;).VNode</span><span style="color: #89DDFF; font-style: italic">}</span><span style="color: #546E7A; font-style: italic"> </span><span style="color: #EEFFFF; font-style: italic">root</span></span>
<span class="line"><span style="color: #546E7A; font-style: italic"> * </span><span style="color: #89DDFF; font-style: italic">@</span><span style="color: #C792EA; font-style: italic">returns</span><span style="color: #546E7A; font-style: italic"> </span><span style="color: #89DDFF; font-style: italic">{</span><span style="color: #FFCB6B; font-style: italic">Promise&lt;string&gt;</span><span style="color: #89DDFF; font-style: italic">}</span></span>
<span class="line"><span style="color: #546E7A; font-style: italic"> */</span></span>
<span class="line"><span style="color: #C792EA">async</span><span style="color: #EEFFFF"> </span><span style="color: #C792EA">function</span><span style="color: #EEFFFF"> </span><span style="color: #82AAFF">render</span><span style="color: #89DDFF">(</span><span style="color: #EEFFFF; font-style: italic">root</span><span style="color: #89DDFF">)</span><span style="color: #EEFFFF"> </span><span style="color: #89DDFF">{</span></span>
<span class="line"><span style="color: #F07178">  </span><span style="color: #C792EA">const</span><span style="color: #F07178"> </span><span style="color: #EEFFFF">TemplatePath</span><span style="color: #F07178"> </span><span style="color: #89DDFF">=</span><span style="color: #F07178"> </span><span style="color: #82AAFF">fileURLToPath</span><span style="color: #F07178">(</span><span style="color: #89DDFF">new</span><span style="color: #F07178"> </span><span style="color: #82AAFF">URL</span><span style="color: #F07178">(</span><span style="color: #89DDFF">&#39;</span><span style="color: #C3E88D">../index.html</span><span style="color: #89DDFF">&#39;</span><span style="color: #89DDFF">,</span><span style="color: #F07178"> </span><span style="color: #89DDFF; font-style: italic">import</span><span style="color: #89DDFF">.</span><span style="color: #EEFFFF">meta</span><span style="color: #89DDFF">.</span><span style="color: #EEFFFF">url</span><span style="color: #F07178">))</span></span>
<span class="line"></span>
<span class="line"><span style="color: #F07178">  </span><span style="color: #C792EA">const</span><span style="color: #F07178"> </span><span style="color: #EEFFFF">template</span><span style="color: #F07178"> </span><span style="color: #89DDFF">=</span><span style="color: #F07178"> </span><span style="color: #89DDFF; font-style: italic">await</span><span style="color: #F07178"> </span><span style="color: #82AAFF">readFile</span><span style="color: #F07178">(</span><span style="color: #EEFFFF">TemplatePath</span><span style="color: #89DDFF">,</span><span style="color: #F07178"> </span><span style="color: #89DDFF">{</span><span style="color: #F07178"> encoding</span><span style="color: #89DDFF">:</span><span style="color: #F07178"> </span><span style="color: #89DDFF">&#39;</span><span style="color: #C3E88D">utf-8</span><span style="color: #89DDFF">&#39;</span><span style="color: #F07178"> </span><span style="color: #89DDFF">}</span><span style="color: #F07178">)</span></span>
<span class="line"><span style="color: #F07178">  </span><span style="color: #C792EA">const</span><span style="color: #F07178"> </span><span style="color: #EEFFFF">app</span><span style="color: #F07178"> </span><span style="color: #89DDFF">=</span><span style="color: #F07178"> </span><span style="color: #89DDFF; font-style: italic">await</span><span style="color: #F07178"> </span><span style="color: #82AAFF">renderToString</span><span style="color: #F07178">(</span><span style="color: #EEFFFF">root</span><span style="color: #F07178">)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #F07178">  </span><span style="color: #89DDFF; font-style: italic">return</span><span style="color: #F07178"> </span><span style="color: #EEFFFF">template</span><span style="color: #89DDFF">.</span><span style="color: #82AAFF">replace</span><span style="color: #F07178">(</span><span style="color: #89DDFF">&#39;</span><span style="color: #C3E88D">&lt;!-- App Slot --&gt;</span><span style="color: #89DDFF">&#39;</span><span style="color: #89DDFF">,</span><span style="color: #F07178"> </span><span style="color: #EEFFFF">app</span><span style="color: #F07178">)</span></span>
<span class="line"><span style="color: #89DDFF">}</span></span>
<span class="line"></span></code></pre>
</code></pre><p class="paragraph"><code class="inline-code">pnpm dev:server</code>运行后得到输出,。</p><pre><code class="language-html"><pre class="shiki material-theme" style="background-color: #263238" tabindex="0"><code><span class="line"><span style="color: #89DDFF">&lt;!</span><span style="color: #F07178">DOCTYPE</span><span style="color: #89DDFF"> </span><span style="color: #C792EA">html</span><span style="color: #89DDFF">&gt;</span></span>
<span class="line"><span style="color: #89DDFF">&lt;</span><span style="color: #F07178">html</span><span style="color: #89DDFF"> </span><span style="color: #C792EA">lang</span><span style="color: #89DDFF">=</span><span style="color: #89DDFF">&quot;</span><span style="color: #C3E88D">zh</span><span style="color: #89DDFF">&quot;</span><span style="color: #89DDFF">&gt;</span></span>
<span class="line"><span style="color: #EEFFFF">  </span><span style="color: #89DDFF">&lt;</span><span style="color: #F07178">head</span><span style="color: #89DDFF">&gt;</span></span>
<span class="line"><span style="color: #EEFFFF">    </span><span style="color: #89DDFF">&lt;</span><span style="color: #F07178">meta</span><span style="color: #89DDFF"> </span><span style="color: #C792EA">charset</span><span style="color: #89DDFF">=</span><span style="color: #89DDFF">&quot;</span><span style="color: #C3E88D">UTF-8</span><span style="color: #89DDFF">&quot;</span><span style="color: #89DDFF"> /&gt;</span></span>
<span class="line"><span style="color: #EEFFFF">    </span><span style="color: #89DDFF">&lt;</span><span style="color: #F07178">meta</span><span style="color: #89DDFF"> </span><span style="color: #C792EA">name</span><span style="color: #89DDFF">=</span><span style="color: #89DDFF">&quot;</span><span style="color: #C3E88D">viewport</span><span style="color: #89DDFF">&quot;</span><span style="color: #89DDFF"> </span><span style="color: #C792EA">content</span><span style="color: #89DDFF">=</span><span style="color: #89DDFF">&quot;</span><span style="color: #C3E88D">width=device-width, initial-scale=1.0</span><span style="color: #89DDFF">&quot;</span><span style="color: #89DDFF"> /&gt;</span></span>
<span class="line"><span style="color: #EEFFFF">    </span><span style="color: #89DDFF">&lt;</span><span style="color: #F07178">title</span><span style="color: #89DDFF">&gt;</span><span style="color: #EEFFFF">Mini SSR</span><span style="color: #89DDFF">&lt;/</span><span style="color: #F07178">title</span><span style="color: #89DDFF">&gt;</span></span>
<span class="line"><span style="color: #EEFFFF">  </span><span style="color: #89DDFF">&lt;/</span><span style="color: #F07178">head</span><span style="color: #89DDFF">&gt;</span></span>
<span class="line"><span style="color: #EEFFFF">  </span><span style="color: #89DDFF">&lt;</span><span style="color: #F07178">body</span><span style="color: #89DDFF">&gt;</span></span>
<span class="line"><span style="color: #EEFFFF">    </span><span style="color: #89DDFF">&lt;</span><span style="color: #F07178">div</span><span style="color: #89DDFF"> </span><span style="color: #C792EA">id</span><span style="color: #89DDFF">=</span><span style="color: #89DDFF">&quot;</span><span style="color: #C3E88D">app</span><span style="color: #89DDFF">&quot;</span><span style="color: #89DDFF">&gt;&lt;</span><span style="color: #F07178">h1</span><span style="color: #89DDFF">&gt;</span><span style="color: #EEFFFF">Hello World!</span><span style="color: #89DDFF">&lt;/</span><span style="color: #F07178">h1</span><span style="color: #89DDFF">&gt;&lt;/</span><span style="color: #F07178">div</span><span style="color: #89DDFF">&gt;</span></span>
<span class="line"><span style="color: #EEFFFF">  </span><span style="color: #89DDFF">&lt;/</span><span style="color: #F07178">body</span><span style="color: #89DDFF">&gt;</span></span>
<span class="line"><span style="color: #89DDFF">&lt;/</span><span style="color: #F07178">html</span><span style="color: #89DDFF">&gt;</span></span></code></pre>
</code></pre><p class="paragraph"><a name="WHDHK"></a></p>
          <h2 id="%E6%9E%84%E5%BB%BA%E6%9C%8D%E5%8A%A1%E7%AB%AF" class="header h2">
            <a name="构建服务端" data-level="2" class="anchor" href="#%E6%9E%84%E5%BB%BA%E6%9C%8D%E5%8A%A1%E7%AB%AF">
              <span class="header-link">#</span>
            </a>
            构建服务端
          </h2><p class="paragraph">在<code class="inline-code">entry-server.js</code>中启动一个<code class="inline-code">node</code>服务器，用于响应请求。<br />服务端开启后返回拼接后的<code class="inline-code">html</code>页面, 直接<code class="inline-code">curl localhost:4936</code>后返回了拼接后的<code class="inline-code">html</code>页面，至此就实现了服务端渲染功能。这里的<code class="inline-code">render</code>函数中读取<code class="inline-code">index.html</code>的步骤可以将其改为全局常量，这样就不需要每次请求都进行文件的读取，可以优化首屏渲染时间和服务器资源消耗。</p><pre><code class="language-javascript"><pre class="shiki material-theme" style="background-color: #263238" tabindex="0"><code><span class="line"><span style="color: #89DDFF; font-style: italic">import</span><span style="color: #EEFFFF"> </span><span style="color: #89DDFF">{</span><span style="color: #F07178"> </span><span style="color: #EEFFFF">createServer</span><span style="color: #F07178"> </span><span style="color: #89DDFF">}</span><span style="color: #EEFFFF"> </span><span style="color: #89DDFF; font-style: italic">from</span><span style="color: #EEFFFF"> </span><span style="color: #89DDFF">&#39;</span><span style="color: #C3E88D">node:http</span><span style="color: #89DDFF">&#39;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #546E7A; font-style: italic">// 避免重复读取html模板</span></span>
<span class="line"><span style="color: #C792EA">const</span><span style="color: #EEFFFF"> TemplatePath </span><span style="color: #89DDFF">=</span><span style="color: #EEFFFF"> </span><span style="color: #82AAFF">fileURLToPath</span><span style="color: #EEFFFF">(</span><span style="color: #89DDFF">new</span><span style="color: #EEFFFF"> </span><span style="color: #82AAFF">URL</span><span style="color: #EEFFFF">(</span><span style="color: #89DDFF">&#39;</span><span style="color: #C3E88D">../index.html</span><span style="color: #89DDFF">&#39;</span><span style="color: #89DDFF">,</span><span style="color: #EEFFFF"> </span><span style="color: #89DDFF; font-style: italic">import</span><span style="color: #89DDFF">.</span><span style="color: #EEFFFF">meta</span><span style="color: #89DDFF">.</span><span style="color: #EEFFFF">url))</span></span>
<span class="line"><span style="color: #C792EA">const</span><span style="color: #EEFFFF"> template </span><span style="color: #89DDFF">=</span><span style="color: #EEFFFF"> </span><span style="color: #89DDFF; font-style: italic">await</span><span style="color: #EEFFFF"> </span><span style="color: #82AAFF">readFile</span><span style="color: #EEFFFF">(TemplatePath</span><span style="color: #89DDFF">,</span><span style="color: #EEFFFF"> </span><span style="color: #89DDFF">{</span><span style="color: #EEFFFF"> </span><span style="color: #F07178">encoding</span><span style="color: #89DDFF">:</span><span style="color: #EEFFFF"> </span><span style="color: #89DDFF">&#39;</span><span style="color: #C3E88D">utf-8</span><span style="color: #89DDFF">&#39;</span><span style="color: #EEFFFF"> </span><span style="color: #89DDFF">}</span><span style="color: #EEFFFF">)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C792EA">const</span><span style="color: #EEFFFF"> component </span><span style="color: #89DDFF">=</span><span style="color: #EEFFFF"> </span><span style="color: #82AAFF">h</span><span style="color: #EEFFFF">(</span><span style="color: #89DDFF">&#39;</span><span style="color: #C3E88D">h1</span><span style="color: #89DDFF">&#39;</span><span style="color: #89DDFF">,</span><span style="color: #EEFFFF"> </span><span style="color: #89DDFF">&#39;</span><span style="color: #C3E88D">Hello World!</span><span style="color: #89DDFF">&#39;</span><span style="color: #EEFFFF">)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #82AAFF">startServer</span><span style="color: #EEFFFF">()</span></span>
<span class="line"></span>
<span class="line"><span style="color: #546E7A; font-style: italic">/** </span><span style="color: #89DDFF; font-style: italic">@</span><span style="color: #C792EA; font-style: italic">desc</span><span style="color: #546E7A; font-style: italic"> 启动服务器 */</span></span>
<span class="line"><span style="color: #C792EA">function</span><span style="color: #EEFFFF"> </span><span style="color: #82AAFF">startServer</span><span style="color: #89DDFF">()</span><span style="color: #EEFFFF"> </span><span style="color: #89DDFF">{</span></span>
<span class="line"><span style="color: #F07178">  </span><span style="color: #C792EA">const</span><span style="color: #F07178"> </span><span style="color: #EEFFFF">server</span><span style="color: #F07178"> </span><span style="color: #89DDFF">=</span><span style="color: #F07178"> </span><span style="color: #82AAFF">createServer</span><span style="color: #F07178">(</span><span style="color: #C792EA">async</span><span style="color: #F07178"> </span><span style="color: #89DDFF">(</span><span style="color: #EEFFFF; font-style: italic">req</span><span style="color: #89DDFF">,</span><span style="color: #F07178"> </span><span style="color: #EEFFFF; font-style: italic">res</span><span style="color: #89DDFF">)</span><span style="color: #F07178"> </span><span style="color: #C792EA">=&gt;</span><span style="color: #F07178"> </span><span style="color: #89DDFF">{</span></span>
<span class="line"><span style="color: #F07178">    </span><span style="color: #C792EA">const</span><span style="color: #F07178"> </span><span style="color: #EEFFFF">page</span><span style="color: #F07178"> </span><span style="color: #89DDFF">=</span><span style="color: #F07178"> </span><span style="color: #89DDFF; font-style: italic">await</span><span style="color: #F07178"> </span><span style="color: #82AAFF">render</span><span style="color: #F07178">(</span><span style="color: #EEFFFF">component</span><span style="color: #F07178">)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #F07178">    </span><span style="color: #EEFFFF">res</span><span style="color: #89DDFF">.</span><span style="color: #82AAFF">end</span><span style="color: #F07178">(</span><span style="color: #EEFFFF">page</span><span style="color: #F07178">)</span></span>
<span class="line"><span style="color: #F07178">  </span><span style="color: #89DDFF">}</span><span style="color: #F07178">)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #F07178">  </span><span style="color: #EEFFFF">server</span><span style="color: #89DDFF">.</span><span style="color: #82AAFF">listen</span><span style="color: #F07178">(</span><span style="color: #F78C6C">4936</span><span style="color: #89DDFF">,</span><span style="color: #F07178"> </span><span style="color: #89DDFF">()</span><span style="color: #F07178"> </span><span style="color: #C792EA">=&gt;</span><span style="color: #F07178"> </span><span style="color: #EEFFFF">console</span><span style="color: #89DDFF">.</span><span style="color: #82AAFF">log</span><span style="color: #F07178">(</span><span style="color: #89DDFF">&#39;</span><span style="color: #C3E88D">Listening http://localhost:4936</span><span style="color: #89DDFF">&#39;</span><span style="color: #F07178">))</span></span>
<span class="line"><span style="color: #F07178">  </span><span style="color: #EEFFFF">server</span><span style="color: #89DDFF">.</span><span style="color: #82AAFF">on</span><span style="color: #F07178">(</span><span style="color: #89DDFF">&#39;</span><span style="color: #C3E88D">error</span><span style="color: #89DDFF">&#39;</span><span style="color: #89DDFF">,</span><span style="color: #F07178"> </span><span style="color: #89DDFF">(</span><span style="color: #EEFFFF; font-style: italic">e</span><span style="color: #89DDFF">)</span><span style="color: #F07178"> </span><span style="color: #C792EA">=&gt;</span><span style="color: #F07178"> </span><span style="color: #89DDFF">{</span></span>
<span class="line"><span style="color: #F07178">    </span><span style="color: #EEFFFF">e</span><span style="color: #89DDFF">.</span><span style="color: #EEFFFF">code</span><span style="color: #F07178"> </span><span style="color: #89DDFF">===</span><span style="color: #F07178"> </span><span style="color: #89DDFF">&#39;</span><span style="color: #C3E88D">EADDRINUSE</span><span style="color: #89DDFF">&#39;</span><span style="color: #F07178"> </span><span style="color: #89DDFF">&amp;&amp;</span><span style="color: #F07178"> </span><span style="color: #EEFFFF">console</span><span style="color: #89DDFF">.</span><span style="color: #82AAFF">error</span><span style="color: #F07178">(</span><span style="color: #89DDFF">&#39;</span><span style="color: #C3E88D">port: 4936 is used</span><span style="color: #89DDFF">&#39;</span><span style="color: #F07178">)</span></span>
<span class="line"><span style="color: #F07178">  </span><span style="color: #89DDFF">}</span><span style="color: #F07178">)</span></span>
<span class="line"><span style="color: #89DDFF">}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C792EA">async</span><span style="color: #EEFFFF"> </span><span style="color: #C792EA">function</span><span style="color: #EEFFFF"> </span><span style="color: #82AAFF">render</span><span style="color: #89DDFF">(</span><span style="color: #EEFFFF; font-style: italic">root</span><span style="color: #89DDFF">)</span><span style="color: #EEFFFF"> </span><span style="color: #89DDFF">{</span><span style="color: #546E7A; font-style: italic">/* ... */</span><span style="color: #89DDFF">}</span></span></code></pre>
</code></pre><p class="paragraph">此时浏览器访问<code class="inline-code">localhost:4936</code>即可看到<code class="inline-code">Hello World!</code>
<a name="MwzDL"></a></p>
          <h2 id="%E5%AE%A2%E6%88%B7%E7%AB%AF%E6%BF%80%E6%B4%BB" class="header h2">
            <a name="客户端激活" data-level="2" class="anchor" href="#%E5%AE%A2%E6%88%B7%E7%AB%AF%E6%BF%80%E6%B4%BB">
              <span class="header-link">#</span>
            </a>
            客户端激活
          </h2><p class="paragraph"><a name="jN0nS"></a></p>
          <h3 id="%E8%AE%A1%E6%95%B0%E5%99%A8%E7%BB%84%E4%BB%B6" class="header h3">
            <a name="计数器组件" data-level="3" class="anchor" href="#%E8%AE%A1%E6%95%B0%E5%99%A8%E7%BB%84%E4%BB%B6">
              <span class="header-link">#</span>
            </a>
            计数器组件
          </h3><p class="paragraph">现在我们的页面有<code class="inline-code">html</code>元素，没有<code class="inline-code">css</code>或<code class="inline-code">js</code>。我们先创建一个包含状态和事件的计数器组件。</p><pre><code class="language-javascript"><pre class="shiki material-theme" style="background-color: #263238" tabindex="0"><code><span class="line"><span style="color: #89DDFF; font-style: italic">import</span><span style="color: #EEFFFF"> </span><span style="color: #89DDFF">{</span><span style="color: #F07178"> </span><span style="color: #EEFFFF">defineComponent</span><span style="color: #89DDFF">,</span><span style="color: #F07178"> </span><span style="color: #EEFFFF">h</span><span style="color: #89DDFF">,</span><span style="color: #F07178"> </span><span style="color: #EEFFFF">ref</span><span style="color: #F07178"> </span><span style="color: #89DDFF">}</span><span style="color: #EEFFFF"> </span><span style="color: #89DDFF; font-style: italic">from</span><span style="color: #EEFFFF"> </span><span style="color: #89DDFF">&#39;</span><span style="color: #C3E88D">vue</span><span style="color: #89DDFF">&#39;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C792EA">const</span><span style="color: #EEFFFF"> Counter </span><span style="color: #89DDFF">=</span><span style="color: #EEFFFF"> </span><span style="color: #82AAFF">defineComponent</span><span style="color: #EEFFFF">(</span><span style="color: #89DDFF">()</span><span style="color: #EEFFFF"> </span><span style="color: #C792EA">=&gt;</span><span style="color: #EEFFFF"> </span><span style="color: #89DDFF">{</span></span>
<span class="line"><span style="color: #F07178">  </span><span style="color: #C792EA">const</span><span style="color: #F07178"> </span><span style="color: #EEFFFF">count</span><span style="color: #F07178"> </span><span style="color: #89DDFF">=</span><span style="color: #F07178"> </span><span style="color: #82AAFF">ref</span><span style="color: #F07178">(</span><span style="color: #F78C6C">0</span><span style="color: #F07178">)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #F07178">  </span><span style="color: #C792EA">function</span><span style="color: #F07178"> </span><span style="color: #82AAFF">handleAdd</span><span style="color: #89DDFF">()</span><span style="color: #F07178"> </span><span style="color: #89DDFF">{</span></span>
<span class="line"><span style="color: #F07178">    </span><span style="color: #EEFFFF">count</span><span style="color: #89DDFF">.</span><span style="color: #EEFFFF">value</span><span style="color: #89DDFF">++</span></span>
<span class="line"><span style="color: #F07178">    </span><span style="color: #EEFFFF">console</span><span style="color: #89DDFF">.</span><span style="color: #82AAFF">log</span><span style="color: #F07178">(</span><span style="color: #89DDFF">&#39;</span><span style="color: #C3E88D">add</span><span style="color: #89DDFF">&#39;</span><span style="color: #89DDFF">,</span><span style="color: #F07178"> </span><span style="color: #EEFFFF">count</span><span style="color: #89DDFF">.</span><span style="color: #EEFFFF">value</span><span style="color: #F07178">)</span></span>
<span class="line"><span style="color: #F07178">  </span><span style="color: #89DDFF">}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #F07178">  </span><span style="color: #89DDFF; font-style: italic">return</span><span style="color: #F07178"> </span><span style="color: #89DDFF">()</span><span style="color: #F07178"> </span><span style="color: #C792EA">=&gt;</span></span>
<span class="line"><span style="color: #F07178">    </span><span style="color: #82AAFF">h</span><span style="color: #F07178">(</span><span style="color: #89DDFF">&#39;</span><span style="color: #C3E88D">div</span><span style="color: #89DDFF">&#39;</span><span style="color: #89DDFF">,</span><span style="color: #F07178"> [</span></span>
<span class="line"><span style="color: #F07178">      </span><span style="color: #82AAFF">h</span><span style="color: #F07178">(</span><span style="color: #89DDFF">&#39;</span><span style="color: #C3E88D">p</span><span style="color: #89DDFF">&#39;</span><span style="color: #89DDFF">,</span><span style="color: #F07178"> </span><span style="color: #89DDFF">`</span><span style="color: #C3E88D">count: </span><span style="color: #89DDFF">${</span><span style="color: #EEFFFF">count</span><span style="color: #89DDFF">.</span><span style="color: #EEFFFF">value</span><span style="color: #89DDFF">}`</span><span style="color: #F07178">)</span><span style="color: #89DDFF">,</span></span>
<span class="line"><span style="color: #F07178">      </span><span style="color: #82AAFF">h</span><span style="color: #F07178">(</span><span style="color: #89DDFF">&#39;</span><span style="color: #C3E88D">button</span><span style="color: #89DDFF">&#39;</span><span style="color: #89DDFF">,</span><span style="color: #F07178"> </span><span style="color: #89DDFF">{</span><span style="color: #F07178"> onClick</span><span style="color: #89DDFF">:</span><span style="color: #F07178"> </span><span style="color: #EEFFFF">handleAdd</span><span style="color: #F07178"> </span><span style="color: #89DDFF">},</span><span style="color: #F07178"> </span><span style="color: #89DDFF">&#39;</span><span style="color: #C3E88D">Add</span><span style="color: #89DDFF">&#39;</span><span style="color: #F07178">)</span><span style="color: #89DDFF">,</span></span>
<span class="line"><span style="color: #F07178">    ])</span></span>
<span class="line"><span style="color: #89DDFF">}</span><span style="color: #EEFFFF">)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #89DDFF; font-style: italic">export</span><span style="color: #EEFFFF"> </span><span style="color: #89DDFF; font-style: italic">default</span><span style="color: #EEFFFF"> Counter</span></span>
<span class="line"></span></code></pre>
</code></pre><pre><code class="language-javascript"><pre class="shiki material-theme" style="background-color: #263238" tabindex="0"><code><span class="line"><span style="color: #546E7A; font-style: italic">// import ...</span></span>
<span class="line"><span style="color: #89DDFF; font-style: italic">import</span><span style="color: #EEFFFF"> Counter </span><span style="color: #89DDFF; font-style: italic">from</span><span style="color: #EEFFFF"> </span><span style="color: #89DDFF">&#39;</span><span style="color: #C3E88D">./App.js</span><span style="color: #89DDFF">&#39;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C792EA">const</span><span style="color: #EEFFFF"> component </span><span style="color: #89DDFF">=</span><span style="color: #EEFFFF"> </span><span style="color: #82AAFF">h</span><span style="color: #EEFFFF">(Counter)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #82AAFF">startServer</span><span style="color: #EEFFFF">()</span></span>
<span class="line"><span style="color: #546E7A; font-style: italic">/** </span><span style="color: #89DDFF; font-style: italic">@</span><span style="color: #C792EA; font-style: italic">desc</span><span style="color: #546E7A; font-style: italic"> 启动服务器 */</span></span>
<span class="line"><span style="color: #C792EA">function</span><span style="color: #EEFFFF"> </span><span style="color: #82AAFF">startServer</span><span style="color: #89DDFF">()</span><span style="color: #EEFFFF"> </span><span style="color: #89DDFF">{</span><span style="color: #546E7A; font-style: italic">/* ... */</span><span style="color: #89DDFF">}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #546E7A; font-style: italic">/** </span><span style="color: #89DDFF; font-style: italic">@</span><span style="color: #C792EA; font-style: italic">desc</span><span style="color: #546E7A; font-style: italic"> 渲染并拼接HTML */</span></span>
<span class="line"><span style="color: #C792EA">async</span><span style="color: #EEFFFF"> </span><span style="color: #C792EA">function</span><span style="color: #EEFFFF"> </span><span style="color: #82AAFF">render</span><span style="color: #89DDFF">(</span><span style="color: #EEFFFF; font-style: italic">root</span><span style="color: #89DDFF">)</span><span style="color: #EEFFFF"> </span><span style="color: #89DDFF">{</span><span style="color: #546E7A; font-style: italic">/* ... */</span><span style="color: #89DDFF">}</span></span></code></pre>
</code></pre><p class="paragraph">现在将<code class="inline-code">entry-server.js</code>中渲染的组件改为计数器组件后再次重启服务端（注意这里由于目前是直接给<code class="inline-code">Node.js</code>运行的<code class="inline-code">esm</code>模块，所以在导入模块时需要添加文件后缀），打开浏览器打开<code class="inline-code">localhost:4936</code>可以看到页面已经正常渲染了，但点击按钮却没有任何效果。
<a name="XS1hG"></a></p>
          <h3 id="Hydration" class="header h3">
            <a name="Hydration" data-level="3" class="anchor" href="#Hydration">
              <span class="header-link">#</span>
            </a>
            Hydration
          </h3><p class="paragraph">现在我们需要给客户端的静态页面绑定事件，和响应式数据，这一步官方称为注水或客户端激活(<code class="inline-code">hydration</code>)。当然我们可以直接在客户端使用<code class="inline-code">createApp</code>重新渲染一个<code class="inline-code">CSR</code>应用，不过<code class="inline-code">Vue</code>提供了<code class="inline-code">createSSRApp</code>方法专门用于客户端激活，同<code class="inline-code">createApp</code>一样会返回一个包含<code class="inline-code">mount</code>方法的对象，用于在客户端挂载到应用的根元素上。我们将默认导出改为使用<code class="inline-code">createSSRApp</code>创建应用实例而不是直接导出组件。</p><pre><code class="language-javascript"><pre class="shiki material-theme" style="background-color: #263238" tabindex="0"><code><span class="line"><span style="color: #89DDFF; font-style: italic">import</span><span style="color: #EEFFFF"> </span><span style="color: #89DDFF">{</span><span style="color: #F07178"> </span><span style="color: #EEFFFF">createSSRApp</span><span style="color: #89DDFF">,</span><span style="color: #F07178"> </span><span style="color: #EEFFFF">defineComponent</span><span style="color: #89DDFF">,</span><span style="color: #F07178"> </span><span style="color: #EEFFFF">h</span><span style="color: #89DDFF">,</span><span style="color: #F07178"> </span><span style="color: #EEFFFF">ref</span><span style="color: #F07178"> </span><span style="color: #89DDFF">}</span><span style="color: #EEFFFF"> </span><span style="color: #89DDFF; font-style: italic">from</span><span style="color: #EEFFFF"> </span><span style="color: #89DDFF">&#39;</span><span style="color: #C3E88D">vue</span><span style="color: #89DDFF">&#39;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C792EA">const</span><span style="color: #EEFFFF"> Counter </span><span style="color: #89DDFF">=</span><span style="color: #EEFFFF"> </span><span style="color: #82AAFF">defineComponent</span><span style="color: #EEFFFF">(</span><span style="color: #89DDFF">()</span><span style="color: #EEFFFF"> </span><span style="color: #C792EA">=&gt;</span><span style="color: #EEFFFF"> </span><span style="color: #89DDFF">{</span><span style="color: #546E7A; font-style: italic">/* ... */</span><span style="color: #89DDFF">}</span><span style="color: #EEFFFF">)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #89DDFF; font-style: italic">export</span><span style="color: #EEFFFF"> </span><span style="color: #89DDFF; font-style: italic">default</span><span style="color: #EEFFFF"> </span><span style="color: #89DDFF">()</span><span style="color: #EEFFFF"> </span><span style="color: #C792EA">=&gt;</span><span style="color: #EEFFFF"> </span><span style="color: #82AAFF">createSSRApp</span><span style="color: #EEFFFF">(Counter)</span></span>
<span class="line"></span></code></pre>
</code></pre><p class="paragraph">创建需要在浏览器中运行的激活函数。</p><pre><code class="language-javascript"><pre class="shiki material-theme" style="background-color: #263238" tabindex="0"><code><span class="line"><span style="color: #89DDFF; font-style: italic">import</span><span style="color: #EEFFFF"> createApp </span><span style="color: #89DDFF; font-style: italic">from</span><span style="color: #EEFFFF"> </span><span style="color: #89DDFF">&#39;</span><span style="color: #C3E88D">./App</span><span style="color: #89DDFF">&#39;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #82AAFF">startHydration</span><span style="color: #EEFFFF">()</span></span>
<span class="line"></span>
<span class="line"><span style="color: #546E7A; font-style: italic">/** </span><span style="color: #89DDFF; font-style: italic">@</span><span style="color: #C792EA; font-style: italic">desc</span><span style="color: #546E7A; font-style: italic"> 基于服务端渲染的静态页集成Vue事件绑定，响应式状态等 */</span></span>
<span class="line"><span style="color: #C792EA">function</span><span style="color: #EEFFFF"> </span><span style="color: #82AAFF">startHydration</span><span style="color: #89DDFF">()</span><span style="color: #EEFFFF"> </span><span style="color: #89DDFF">{</span></span>
<span class="line"><span style="color: #F07178">  </span><span style="color: #C792EA">const</span><span style="color: #F07178"> </span><span style="color: #EEFFFF">app</span><span style="color: #F07178"> </span><span style="color: #89DDFF">=</span><span style="color: #F07178"> </span><span style="color: #82AAFF">createApp</span><span style="color: #F07178">()</span></span>
<span class="line"></span>
<span class="line"><span style="color: #F07178">  </span><span style="color: #EEFFFF">app</span><span style="color: #89DDFF">.</span><span style="color: #82AAFF">mount</span><span style="color: #F07178">(</span><span style="color: #89DDFF">&#39;</span><span style="color: #C3E88D">#app</span><span style="color: #89DDFF">&#39;</span><span style="color: #F07178">)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #F07178">  </span><span style="color: #EEFFFF">console</span><span style="color: #89DDFF">.</span><span style="color: #82AAFF">log</span><span style="color: #F07178">(</span><span style="color: #89DDFF">&#39;</span><span style="color: #C3E88D">hydration success</span><span style="color: #89DDFF">&#39;</span><span style="color: #F07178">)</span></span>
<span class="line"><span style="color: #89DDFF">}</span></span>
<span class="line"></span></code></pre>
</code></pre><p class="paragraph">我们还需要打包一下<code class="inline-code">entry-client.js</code>将<code class="inline-code">vue</code>打包入该文件，当然使用<code class="inline-code">CDN</code>的方式导入也可以。这里使用<code class="inline-code">esbuild</code>打包。</p><pre><code class="language-bash"><pre class="shiki material-theme" style="background-color: #263238" tabindex="0"><code><span class="line"><span style="color: #FFCB6B">pnpm</span><span style="color: #EEFFFF"> </span><span style="color: #C3E88D">i</span><span style="color: #EEFFFF"> </span><span style="color: #C3E88D">esbuild</span><span style="color: #EEFFFF"> </span><span style="color: #C3E88D">-D</span></span></code></pre>
</code></pre><pre><code class="language-javascript"><pre class="shiki material-theme" style="background-color: #263238" tabindex="0"><code><span class="line"><span style="color: #89DDFF; font-style: italic">import</span><span style="color: #EEFFFF"> </span><span style="color: #89DDFF">{</span><span style="color: #F07178"> </span><span style="color: #EEFFFF">build</span><span style="color: #F07178"> </span><span style="color: #89DDFF">}</span><span style="color: #EEFFFF"> </span><span style="color: #89DDFF; font-style: italic">from</span><span style="color: #EEFFFF"> </span><span style="color: #89DDFF">&#39;</span><span style="color: #C3E88D">esbuild</span><span style="color: #89DDFF">&#39;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #89DDFF; font-style: italic">import</span><span style="color: #EEFFFF"> </span><span style="color: #89DDFF">{</span><span style="color: #F07178"> </span><span style="color: #EEFFFF">resolve</span><span style="color: #F07178"> </span><span style="color: #89DDFF">}</span><span style="color: #EEFFFF"> </span><span style="color: #89DDFF; font-style: italic">from</span><span style="color: #EEFFFF"> </span><span style="color: #89DDFF">&#39;</span><span style="color: #C3E88D">node:path</span><span style="color: #89DDFF">&#39;</span></span>
<span class="line"><span style="color: #89DDFF; font-style: italic">import</span><span style="color: #EEFFFF"> </span><span style="color: #89DDFF">{</span><span style="color: #F07178"> </span><span style="color: #EEFFFF">fileURLToPath</span><span style="color: #F07178"> </span><span style="color: #89DDFF">}</span><span style="color: #EEFFFF"> </span><span style="color: #89DDFF; font-style: italic">from</span><span style="color: #EEFFFF"> </span><span style="color: #89DDFF">&#39;</span><span style="color: #C3E88D">node:url</span><span style="color: #89DDFF">&#39;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #82AAFF">buildEntryClient</span><span style="color: #EEFFFF">()</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C792EA">function</span><span style="color: #EEFFFF"> </span><span style="color: #82AAFF">buildEntryClient</span><span style="color: #89DDFF">()</span><span style="color: #EEFFFF"> </span><span style="color: #89DDFF">{</span></span>
<span class="line"><span style="color: #F07178">  </span><span style="color: #C792EA">const</span><span style="color: #F07178"> </span><span style="color: #EEFFFF">RootDir</span><span style="color: #F07178"> </span><span style="color: #89DDFF">=</span><span style="color: #F07178"> </span><span style="color: #82AAFF">fileURLToPath</span><span style="color: #F07178">(</span><span style="color: #89DDFF">new</span><span style="color: #F07178"> </span><span style="color: #82AAFF">URL</span><span style="color: #F07178">(</span><span style="color: #89DDFF">&#39;</span><span style="color: #C3E88D">..</span><span style="color: #89DDFF">&#39;</span><span style="color: #89DDFF">,</span><span style="color: #F07178"> </span><span style="color: #89DDFF; font-style: italic">import</span><span style="color: #89DDFF">.</span><span style="color: #EEFFFF">meta</span><span style="color: #89DDFF">.</span><span style="color: #EEFFFF">url</span><span style="color: #F07178">))</span></span>
<span class="line"></span>
<span class="line"><span style="color: #F07178">  </span><span style="color: #82AAFF">build</span><span style="color: #F07178">(</span><span style="color: #89DDFF">{</span></span>
<span class="line"><span style="color: #F07178">    bundle</span><span style="color: #89DDFF">:</span><span style="color: #F07178"> </span><span style="color: #FF9CAC">true</span><span style="color: #89DDFF">,</span></span>
<span class="line"><span style="color: #F07178">    format</span><span style="color: #89DDFF">:</span><span style="color: #F07178"> </span><span style="color: #89DDFF">&#39;</span><span style="color: #C3E88D">esm</span><span style="color: #89DDFF">&#39;</span><span style="color: #89DDFF">,</span></span>
<span class="line"><span style="color: #F07178">    target</span><span style="color: #89DDFF">:</span><span style="color: #F07178"> [</span><span style="color: #89DDFF">&#39;</span><span style="color: #C3E88D">es2022</span><span style="color: #89DDFF">&#39;</span><span style="color: #F07178">]</span><span style="color: #89DDFF">,</span></span>
<span class="line"><span style="color: #F07178">    platform</span><span style="color: #89DDFF">:</span><span style="color: #F07178"> </span><span style="color: #89DDFF">&#39;</span><span style="color: #C3E88D">browser</span><span style="color: #89DDFF">&#39;</span><span style="color: #89DDFF">,</span></span>
<span class="line"><span style="color: #F07178">    entryPoints</span><span style="color: #89DDFF">:</span><span style="color: #F07178"> [</span><span style="color: #82AAFF">resolve</span><span style="color: #F07178">(</span><span style="color: #EEFFFF">RootDir</span><span style="color: #89DDFF">,</span><span style="color: #F07178"> </span><span style="color: #89DDFF">&#39;</span><span style="color: #C3E88D">src/entry-client.js</span><span style="color: #89DDFF">&#39;</span><span style="color: #F07178">)]</span><span style="color: #89DDFF">,</span></span>
<span class="line"><span style="color: #F07178">    outfile</span><span style="color: #89DDFF">:</span><span style="color: #F07178"> </span><span style="color: #82AAFF">resolve</span><span style="color: #F07178">(</span><span style="color: #EEFFFF">RootDir</span><span style="color: #89DDFF">,</span><span style="color: #F07178"> </span><span style="color: #89DDFF">&#39;</span><span style="color: #C3E88D">dist/entry-client.js</span><span style="color: #89DDFF">&#39;</span><span style="color: #F07178">)</span><span style="color: #89DDFF">,</span></span>
<span class="line"><span style="color: #F07178">    define</span><span style="color: #89DDFF">:</span><span style="color: #F07178"> </span><span style="color: #89DDFF">{</span></span>
<span class="line"><span style="color: #F07178">      </span><span style="color: #89DDFF">&#39;</span><span style="color: #F07178">process.env.NODE_ENV</span><span style="color: #89DDFF">&#39;</span><span style="color: #89DDFF">:</span><span style="color: #F07178"> </span><span style="color: #89DDFF">&#39;</span><span style="color: #C3E88D">&quot;production&quot;</span><span style="color: #89DDFF">&#39;</span><span style="color: #89DDFF">,</span></span>
<span class="line"><span style="color: #F07178">      __VUE_PROD_DEVTOOLS__</span><span style="color: #89DDFF">:</span><span style="color: #F07178"> </span><span style="color: #89DDFF">&#39;</span><span style="color: #C3E88D">false</span><span style="color: #89DDFF">&#39;</span><span style="color: #89DDFF">,</span></span>
<span class="line"><span style="color: #F07178">      __VUE_OPTIONS_API__</span><span style="color: #89DDFF">:</span><span style="color: #F07178"> </span><span style="color: #89DDFF">&#39;</span><span style="color: #C3E88D">false</span><span style="color: #89DDFF">&#39;</span><span style="color: #89DDFF">,</span></span>
<span class="line"><span style="color: #F07178">    </span><span style="color: #89DDFF">},</span></span>
<span class="line"><span style="color: #F07178">  </span><span style="color: #89DDFF">}</span><span style="color: #F07178">)</span></span>
<span class="line"><span style="color: #89DDFF">}</span></span>
<span class="line"></span></code></pre>
</code></pre><p class="paragraph">添加一下<code class="inline-code">package.json</code>的脚本,执行一下<code class="inline-code">pnpm build:client</code>即可看到已经将<code class="inline-code">entry-client.js</code>打包在<code class="inline-code">dist</code>目录下了。</p><pre><code class="language-json"><pre class="shiki material-theme" style="background-color: #263238" tabindex="0"><code><span class="line"><span style="color: #89DDFF">{</span></span>
<span class="line"><span style="color: #EEFFFF">  </span><span style="color: #89DDFF">&quot;</span><span style="color: #C792EA">type</span><span style="color: #89DDFF">&quot;</span><span style="color: #89DDFF">:</span><span style="color: #EEFFFF"> </span><span style="color: #89DDFF">&quot;</span><span style="color: #C3E88D">module</span><span style="color: #89DDFF">&quot;</span><span style="color: #89DDFF">,</span></span>
<span class="line"><span style="color: #EEFFFF">  </span><span style="color: #89DDFF">&quot;</span><span style="color: #C792EA">scripts</span><span style="color: #89DDFF">&quot;</span><span style="color: #89DDFF">:</span><span style="color: #EEFFFF"> </span><span style="color: #89DDFF">{</span></span>
<span class="line"><span style="color: #EEFFFF">    </span><span style="color: #89DDFF">&quot;</span><span style="color: #FFCB6B">build:client</span><span style="color: #89DDFF">&quot;</span><span style="color: #89DDFF">:</span><span style="color: #EEFFFF"> </span><span style="color: #89DDFF">&quot;</span><span style="color: #C3E88D">node ./scripts/build.js</span><span style="color: #89DDFF">&quot;</span><span style="color: #89DDFF">,</span></span>
<span class="line"><span style="color: #EEFFFF">    </span><span style="color: #89DDFF">&quot;</span><span style="color: #FFCB6B">dev:server</span><span style="color: #89DDFF">&quot;</span><span style="color: #89DDFF">:</span><span style="color: #EEFFFF"> </span><span style="color: #89DDFF">&quot;</span><span style="color: #C3E88D">pnpm build:client &amp;&amp; node ./src/entry-server.js</span><span style="color: #89DDFF">&quot;</span></span>
<span class="line"><span style="color: #EEFFFF">  </span><span style="color: #89DDFF">},</span></span>
<span class="line"><span style="color: #EEFFFF">  </span><span style="color: #89DDFF">&quot;</span><span style="color: #C792EA">dependencies</span><span style="color: #89DDFF">&quot;</span><span style="color: #89DDFF">:</span><span style="color: #EEFFFF"> </span><span style="color: #89DDFF">{</span></span>
<span class="line"><span style="color: #EEFFFF">    </span><span style="color: #89DDFF">&quot;</span><span style="color: #FFCB6B">vue</span><span style="color: #89DDFF">&quot;</span><span style="color: #89DDFF">:</span><span style="color: #EEFFFF"> </span><span style="color: #89DDFF">&quot;</span><span style="color: #C3E88D">^3.3.7</span><span style="color: #89DDFF">&quot;</span></span>
<span class="line"><span style="color: #EEFFFF">  </span><span style="color: #89DDFF">},</span></span>
<span class="line"><span style="color: #EEFFFF">  </span><span style="color: #89DDFF">&quot;</span><span style="color: #C792EA">devDependencies</span><span style="color: #89DDFF">&quot;</span><span style="color: #89DDFF">:</span><span style="color: #EEFFFF"> </span><span style="color: #89DDFF">{</span></span>
<span class="line"><span style="color: #EEFFFF">    </span><span style="color: #89DDFF">&quot;</span><span style="color: #FFCB6B">@types/node</span><span style="color: #89DDFF">&quot;</span><span style="color: #89DDFF">:</span><span style="color: #EEFFFF"> </span><span style="color: #89DDFF">&quot;</span><span style="color: #C3E88D">^20.8.8</span><span style="color: #89DDFF">&quot;</span><span style="color: #89DDFF">,</span></span>
<span class="line"><span style="color: #EEFFFF">    </span><span style="color: #89DDFF">&quot;</span><span style="color: #FFCB6B">esbuild</span><span style="color: #89DDFF">&quot;</span><span style="color: #89DDFF">:</span><span style="color: #EEFFFF"> </span><span style="color: #89DDFF">&quot;</span><span style="color: #C3E88D">^0.19.5</span><span style="color: #89DDFF">&quot;</span></span>
<span class="line"><span style="color: #EEFFFF">  </span><span style="color: #89DDFF">}</span></span>
<span class="line"><span style="color: #89DDFF">}</span></span>
<span class="line"></span></code></pre>
</code></pre><p class="paragraph"><a name="CsPbf"></a></p>
          <h2 id="%E9%9D%99%E6%80%81%E8%B5%84%E6%BA%90%E6%9C%8D%E5%8A%A1" class="header h2">
            <a name="静态资源服务" data-level="2" class="anchor" href="#%E9%9D%99%E6%80%81%E8%B5%84%E6%BA%90%E6%9C%8D%E5%8A%A1">
              <span class="header-link">#</span>
            </a>
            静态资源服务
          </h2><p class="paragraph"><a name="ISqeV"></a></p>
          <h3 id="%E5%BC%95%E5%85%A5%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%85%A5%E5%8F%A3%E6%96%87%E4%BB%B6" class="header h3">
            <a name="引入客户端入口文件" data-level="3" class="anchor" href="#%E5%BC%95%E5%85%A5%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%85%A5%E5%8F%A3%E6%96%87%E4%BB%B6">
              <span class="header-link">#</span>
            </a>
            引入客户端入口文件
          </h3><p class="paragraph">现在在我们的<code class="inline-code">index.html</code>中引入客户端激活脚本<code class="inline-code">dist/entry-client.js</code>，记得要在<code class="inline-code">script</code>标签上添加<code class="inline-code">type=&quot;module&quot;</code>或<code class="inline-code">defer</code>属性，或者将其移到<code class="inline-code">div#app</code>元素下方 (确保<code class="inline-code">app.mount(&#39;#app&#39;)</code>脚本运行时元素已经存在)。</p><p class="paragraph">顺带一笔，刚开始打算直接把<code class="inline-code">dist/entry-client.js</code>中的内容拼接到<code class="inline-code">html</code>的<code class="inline-code">script</code>标签内，但这加大了网页爬虫的加载时间，若拼接在<code class="inline-code">html</code>内，则使用<code class="inline-code">curl</code>访问时会将<code class="inline-code">javascript</code>文件也拉下来，而通过<code class="inline-code">script</code>的<code class="inline-code">src</code>方式导入则只仅会显示一个标签，爬虫可以更快的获取到页面。</p><p class="paragraph">但相应的客户端就要再次发起请求获取<code class="inline-code">js</code>了，在请求<code class="inline-code">js</code>期间不能处理页面的用户事件(在慢速<code class="inline-code">3G</code>的网络下慢了2s左右，但对于爬虫完成<code class="inline-code">html</code>请求快了3.7s左右)。<br /><img src="https://cdn.nlark.com/yuque/0/2023/png/22950541/1698245454593-02c68d34-c77a-4d7d-bf8c-ed9f855ecefb.png#averageHue=%23f5f4f3&clientId=uf901401a-2be9-4&from=paste&height=260&id=ua72f78ce&originHeight=325&originWidth=1198&originalType=binary&ratio=1.25&rotation=0&showTitle=true&size=47243&status=done&style=none&taskId=u260ee234-d8bb-424c-a63a-22b8d494946&title=%E4%BD%BF%E7%94%A8script%20src%E5%B1%9E%E6%80%A7%E5%8A%A0%E8%BD%BD&width=958.4" alt="使用script src属性加载" title="使用script src属性加载"><br /><img src="https://cdn.nlark.com/yuque/0/2023/png/22950541/1698245459157-4129c85e-d995-4d98-b811-24a9553f302a.png#averageHue=%23f5f4f3&clientId=uf901401a-2be9-4&from=paste&height=235&id=u06fe5d71&originHeight=294&originWidth=1200&originalType=binary&ratio=1.25&rotation=0&showTitle=true&size=42753&status=done&style=none&taskId=u68ee15dc-ab5e-4c06-8760-ce926012ebe&title=%E4%BD%BF%E7%94%A8%E5%86%85%E8%81%94%E7%9A%84script%E6%A0%87%E7%AD%BE&width=960" alt="使用内联的script标签" title="使用内联的script标签"></p><pre><code class="language-html"><pre class="shiki material-theme" style="background-color: #263238" tabindex="0"><code><span class="line"><span style="color: #89DDFF">&lt;!</span><span style="color: #F07178">DOCTYPE</span><span style="color: #89DDFF"> </span><span style="color: #C792EA">html</span><span style="color: #89DDFF">&gt;</span></span>
<span class="line"><span style="color: #89DDFF">&lt;</span><span style="color: #F07178">html</span><span style="color: #89DDFF"> </span><span style="color: #C792EA">lang</span><span style="color: #89DDFF">=</span><span style="color: #89DDFF">&quot;</span><span style="color: #C3E88D">zh</span><span style="color: #89DDFF">&quot;</span><span style="color: #89DDFF">&gt;</span></span>
<span class="line"><span style="color: #EEFFFF">  </span><span style="color: #89DDFF">&lt;</span><span style="color: #F07178">head</span><span style="color: #89DDFF">&gt;</span></span>
<span class="line"><span style="color: #EEFFFF">    </span><span style="color: #89DDFF">&lt;</span><span style="color: #F07178">meta</span><span style="color: #89DDFF"> </span><span style="color: #C792EA">charset</span><span style="color: #89DDFF">=</span><span style="color: #89DDFF">&quot;</span><span style="color: #C3E88D">UTF-8</span><span style="color: #89DDFF">&quot;</span><span style="color: #89DDFF"> /&gt;</span></span>
<span class="line"><span style="color: #EEFFFF">    </span><span style="color: #89DDFF">&lt;</span><span style="color: #F07178">meta</span><span style="color: #89DDFF"> </span><span style="color: #C792EA">name</span><span style="color: #89DDFF">=</span><span style="color: #89DDFF">&quot;</span><span style="color: #C3E88D">viewport</span><span style="color: #89DDFF">&quot;</span><span style="color: #89DDFF"> </span><span style="color: #C792EA">content</span><span style="color: #89DDFF">=</span><span style="color: #89DDFF">&quot;</span><span style="color: #C3E88D">width=device-width, initial-scale=1.0</span><span style="color: #89DDFF">&quot;</span><span style="color: #89DDFF"> /&gt;</span></span>
<span class="line"><span style="color: #EEFFFF">    </span><span style="color: #89DDFF">&lt;</span><span style="color: #F07178">title</span><span style="color: #89DDFF">&gt;</span><span style="color: #EEFFFF">Mini SSR</span><span style="color: #89DDFF">&lt;/</span><span style="color: #F07178">title</span><span style="color: #89DDFF">&gt;</span></span>
<span class="line"><span style="color: #89DDFF">    &lt;</span><span style="color: #F07178">script</span><span style="color: #89DDFF"> </span><span style="color: #C792EA">type</span><span style="color: #89DDFF">=</span><span style="color: #89DDFF">&quot;</span><span style="color: #C3E88D">module</span><span style="color: #89DDFF">&quot;</span><span style="color: #89DDFF"> </span><span style="color: #C792EA">src</span><span style="color: #89DDFF">=</span><span style="color: #89DDFF">&quot;</span><span style="color: #C3E88D">dist/entry-client.js</span><span style="color: #89DDFF">&quot;</span><span style="color: #89DDFF"> &gt;&lt;/</span><span style="color: #F07178">script</span><span style="color: #89DDFF">&gt;</span></span>
<span class="line"><span style="color: #EEFFFF">  </span><span style="color: #89DDFF">&lt;/</span><span style="color: #F07178">head</span><span style="color: #89DDFF">&gt;</span></span>
<span class="line"><span style="color: #EEFFFF">  </span><span style="color: #89DDFF">&lt;</span><span style="color: #F07178">body</span><span style="color: #89DDFF">&gt;</span></span>
<span class="line"><span style="color: #EEFFFF">    </span><span style="color: #89DDFF">&lt;</span><span style="color: #F07178">div</span><span style="color: #89DDFF"> </span><span style="color: #C792EA">id</span><span style="color: #89DDFF">=</span><span style="color: #89DDFF">&quot;</span><span style="color: #C3E88D">app</span><span style="color: #89DDFF">&quot;</span><span style="color: #89DDFF">&gt;</span><span style="color: #546E7A; font-style: italic">&lt;!-- App Slot --&gt;</span><span style="color: #89DDFF">&lt;/</span><span style="color: #F07178">div</span><span style="color: #89DDFF">&gt;</span></span>
<span class="line"><span style="color: #EEFFFF">  </span><span style="color: #89DDFF">&lt;/</span><span style="color: #F07178">body</span><span style="color: #89DDFF">&gt;</span></span>
<span class="line"><span style="color: #89DDFF">&lt;/</span><span style="color: #F07178">html</span><span style="color: #89DDFF">&gt;</span></span>
<span class="line"></span></code></pre>
</code></pre><p class="paragraph">浏览器会请求静态资源，此时就需要在服务端处理静态资源请求服务，若请求路径存在后缀则判定为请求静态资源，否则返回服务端渲染界面。至此就完成了基本的服务端渲染了，浏览器打开<code class="inline-code">localhost:4936</code>计数器正常渲染，并且<code class="inline-code">vue</code>也与客户端<code class="inline-code">DOM</code>绑定了响应式数据。</p><p class="paragraph">使用<code class="inline-code">createSSRApp</code>函数创建的实例不应该被重复使用，而应在每次响应时都创建一个新的实例，否则在第二次请求时服务端控制台会发出如下警告：<br /><code class="inline-code">[Vue warn]: App already provides property with key &quot;Symbol(v-scx)&quot;. It will be overwritten with the new value.</code><br />若还使用了路由与状态管理插件则可能会影响不同请求的渲染结果（官方文档：<a href="https://cn.vuejs.org/guide/scaling-up/ssr.html#cross-request-state-pollution" title="null" class="link">跨请求状态污染</a>）。</p><pre><code class="language-javascript"><pre class="shiki material-theme" style="background-color: #263238" tabindex="0"><code><span class="line"><span style="color: #89DDFF; font-style: italic">import</span><span style="color: #EEFFFF"> </span><span style="color: #89DDFF">{</span><span style="color: #F07178"> </span><span style="color: #EEFFFF">renderToString</span><span style="color: #F07178"> </span><span style="color: #89DDFF">}</span><span style="color: #EEFFFF"> </span><span style="color: #89DDFF; font-style: italic">from</span><span style="color: #EEFFFF"> </span><span style="color: #89DDFF">&#39;</span><span style="color: #C3E88D">vue/server-renderer</span><span style="color: #89DDFF">&#39;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #89DDFF; font-style: italic">import</span><span style="color: #EEFFFF"> </span><span style="color: #89DDFF">{</span><span style="color: #F07178"> </span><span style="color: #EEFFFF">readFile</span><span style="color: #89DDFF">,</span><span style="color: #F07178"> </span><span style="color: #EEFFFF">stat</span><span style="color: #F07178"> </span><span style="color: #89DDFF">}</span><span style="color: #EEFFFF"> </span><span style="color: #89DDFF; font-style: italic">from</span><span style="color: #EEFFFF"> </span><span style="color: #89DDFF">&#39;</span><span style="color: #C3E88D">node:fs/promises</span><span style="color: #89DDFF">&#39;</span></span>
<span class="line"><span style="color: #89DDFF; font-style: italic">import</span><span style="color: #EEFFFF"> </span><span style="color: #89DDFF">{</span><span style="color: #F07178"> </span><span style="color: #EEFFFF">createReadStream</span><span style="color: #F07178"> </span><span style="color: #89DDFF">}</span><span style="color: #EEFFFF"> </span><span style="color: #89DDFF; font-style: italic">from</span><span style="color: #EEFFFF"> </span><span style="color: #89DDFF">&#39;</span><span style="color: #C3E88D">node:fs</span><span style="color: #89DDFF">&#39;</span></span>
<span class="line"><span style="color: #89DDFF; font-style: italic">import</span><span style="color: #EEFFFF"> </span><span style="color: #89DDFF">{</span><span style="color: #F07178"> </span><span style="color: #EEFFFF">fileURLToPath</span><span style="color: #F07178"> </span><span style="color: #89DDFF">}</span><span style="color: #EEFFFF"> </span><span style="color: #89DDFF; font-style: italic">from</span><span style="color: #EEFFFF"> </span><span style="color: #89DDFF">&#39;</span><span style="color: #C3E88D">node:url</span><span style="color: #89DDFF">&#39;</span></span>
<span class="line"><span style="color: #89DDFF; font-style: italic">import</span><span style="color: #EEFFFF"> </span><span style="color: #89DDFF">{</span><span style="color: #F07178"> </span><span style="color: #EEFFFF">createServer</span><span style="color: #F07178"> </span><span style="color: #89DDFF">}</span><span style="color: #EEFFFF"> </span><span style="color: #89DDFF; font-style: italic">from</span><span style="color: #EEFFFF"> </span><span style="color: #89DDFF">&#39;</span><span style="color: #C3E88D">node:http</span><span style="color: #89DDFF">&#39;</span></span>
<span class="line"><span style="color: #89DDFF; font-style: italic">import</span><span style="color: #EEFFFF"> </span><span style="color: #89DDFF">{</span><span style="color: #F07178"> </span><span style="color: #EEFFFF">extname</span><span style="color: #F07178"> </span><span style="color: #89DDFF">}</span><span style="color: #EEFFFF"> </span><span style="color: #89DDFF; font-style: italic">from</span><span style="color: #EEFFFF"> </span><span style="color: #89DDFF">&#39;</span><span style="color: #C3E88D">node:path</span><span style="color: #89DDFF">&#39;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #89DDFF; font-style: italic">import</span><span style="color: #EEFFFF"> createApp </span><span style="color: #89DDFF; font-style: italic">from</span><span style="color: #EEFFFF"> </span><span style="color: #89DDFF">&#39;</span><span style="color: #C3E88D">./App.js</span><span style="color: #89DDFF">&#39;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C792EA">const</span><span style="color: #EEFFFF"> TemplatePath </span><span style="color: #89DDFF">=</span><span style="color: #EEFFFF"> </span><span style="color: #82AAFF">fileURLToPath</span><span style="color: #EEFFFF">(</span><span style="color: #89DDFF">new</span><span style="color: #EEFFFF"> </span><span style="color: #82AAFF">URL</span><span style="color: #EEFFFF">(</span><span style="color: #89DDFF">&#39;</span><span style="color: #C3E88D">../index.html</span><span style="color: #89DDFF">&#39;</span><span style="color: #89DDFF">,</span><span style="color: #EEFFFF"> </span><span style="color: #89DDFF; font-style: italic">import</span><span style="color: #89DDFF">.</span><span style="color: #EEFFFF">meta</span><span style="color: #89DDFF">.</span><span style="color: #EEFFFF">url))</span></span>
<span class="line"><span style="color: #C792EA">const</span><span style="color: #EEFFFF"> template </span><span style="color: #89DDFF">=</span><span style="color: #EEFFFF"> </span><span style="color: #89DDFF; font-style: italic">await</span><span style="color: #EEFFFF"> </span><span style="color: #82AAFF">readFile</span><span style="color: #EEFFFF">(TemplatePath</span><span style="color: #89DDFF">,</span><span style="color: #EEFFFF"> </span><span style="color: #89DDFF">{</span><span style="color: #EEFFFF"> </span><span style="color: #F07178">encoding</span><span style="color: #89DDFF">:</span><span style="color: #EEFFFF"> </span><span style="color: #89DDFF">&#39;</span><span style="color: #C3E88D">utf-8</span><span style="color: #89DDFF">&#39;</span><span style="color: #EEFFFF"> </span><span style="color: #89DDFF">}</span><span style="color: #EEFFFF">)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #546E7A; font-style: italic">// const app = createApp()</span></span>
<span class="line"></span>
<span class="line"><span style="color: #82AAFF">startServer</span><span style="color: #EEFFFF">()</span></span>
<span class="line"></span>
<span class="line"><span style="color: #546E7A; font-style: italic">/** </span><span style="color: #89DDFF; font-style: italic">@</span><span style="color: #C792EA; font-style: italic">desc</span><span style="color: #546E7A; font-style: italic"> 启动服务器 */</span></span>
<span class="line"><span style="color: #C792EA">function</span><span style="color: #EEFFFF"> </span><span style="color: #82AAFF">startServer</span><span style="color: #89DDFF">()</span><span style="color: #EEFFFF"> </span><span style="color: #89DDFF">{</span></span>
<span class="line"><span style="color: #F07178">  </span><span style="color: #C792EA">const</span><span style="color: #F07178"> </span><span style="color: #EEFFFF">server</span><span style="color: #F07178"> </span><span style="color: #89DDFF">=</span><span style="color: #F07178"> </span><span style="color: #82AAFF">createServer</span><span style="color: #F07178">(</span><span style="color: #C792EA">async</span><span style="color: #F07178"> </span><span style="color: #89DDFF">({</span><span style="color: #F07178"> </span><span style="color: #EEFFFF; font-style: italic">url</span><span style="color: #F07178"> </span><span style="color: #89DDFF">=</span><span style="color: #F07178"> </span><span style="color: #89DDFF">&#39;</span><span style="color: #C3E88D">/</span><span style="color: #89DDFF">&#39;</span><span style="color: #F07178"> </span><span style="color: #89DDFF">},</span><span style="color: #F07178"> </span><span style="color: #EEFFFF; font-style: italic">res</span><span style="color: #89DDFF">)</span><span style="color: #F07178"> </span><span style="color: #C792EA">=&gt;</span><span style="color: #F07178"> </span><span style="color: #89DDFF">{</span></span>
<span class="line"><span style="color: #F07178">    </span><span style="color: #89DDFF; font-style: italic">if</span><span style="color: #F07178"> (</span><span style="color: #82AAFF">extname</span><span style="color: #F07178">(</span><span style="color: #EEFFFF">url</span><span style="color: #F07178">) </span><span style="color: #89DDFF">!==</span><span style="color: #F07178"> </span><span style="color: #89DDFF">&#39;&#39;</span><span style="color: #F07178">) </span><span style="color: #89DDFF">{</span></span>
<span class="line"><span style="color: #F07178">      </span><span style="color: #82AAFF">staticService</span><span style="color: #F07178">(</span><span style="color: #EEFFFF">url</span><span style="color: #89DDFF">,</span><span style="color: #F07178"> </span><span style="color: #EEFFFF">res</span><span style="color: #F07178">)</span></span>
<span class="line"><span style="color: #F07178">    </span><span style="color: #89DDFF">}</span><span style="color: #F07178"> </span><span style="color: #89DDFF; font-style: italic">else</span><span style="color: #F07178"> </span><span style="color: #89DDFF">{</span></span>
<span class="line"><span style="color: #F07178">      </span><span style="color: #C792EA">const</span><span style="color: #F07178"> </span><span style="color: #EEFFFF">app</span><span style="color: #F07178"> </span><span style="color: #89DDFF">=</span><span style="color: #F07178"> </span><span style="color: #82AAFF">createApp</span><span style="color: #F07178">()</span></span>
<span class="line"><span style="color: #F07178">      </span><span style="color: #C792EA">const</span><span style="color: #F07178"> </span><span style="color: #EEFFFF">page</span><span style="color: #F07178"> </span><span style="color: #89DDFF">=</span><span style="color: #F07178"> </span><span style="color: #89DDFF; font-style: italic">await</span><span style="color: #F07178"> </span><span style="color: #82AAFF">render</span><span style="color: #F07178">(</span><span style="color: #EEFFFF">app</span><span style="color: #F07178">)</span></span>
<span class="line"><span style="color: #F07178">      </span><span style="color: #EEFFFF">res</span><span style="color: #89DDFF">.</span><span style="color: #82AAFF">end</span><span style="color: #F07178">(</span><span style="color: #EEFFFF">page</span><span style="color: #F07178">)</span></span>
<span class="line"><span style="color: #F07178">    </span><span style="color: #89DDFF">}</span></span>
<span class="line"><span style="color: #F07178">  </span><span style="color: #89DDFF">}</span><span style="color: #F07178">)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #F07178">  </span><span style="color: #EEFFFF">server</span><span style="color: #89DDFF">.</span><span style="color: #82AAFF">listen</span><span style="color: #F07178">(</span><span style="color: #F78C6C">4936</span><span style="color: #89DDFF">,</span><span style="color: #F07178"> </span><span style="color: #89DDFF">()</span><span style="color: #F07178"> </span><span style="color: #C792EA">=&gt;</span><span style="color: #F07178"> </span><span style="color: #EEFFFF">console</span><span style="color: #89DDFF">.</span><span style="color: #82AAFF">log</span><span style="color: #F07178">(</span><span style="color: #89DDFF">&#39;</span><span style="color: #C3E88D">Listening http://localhost:4936</span><span style="color: #89DDFF">&#39;</span><span style="color: #F07178">))</span></span>
<span class="line"><span style="color: #F07178">  </span><span style="color: #EEFFFF">server</span><span style="color: #89DDFF">.</span><span style="color: #82AAFF">on</span><span style="color: #F07178">(</span><span style="color: #89DDFF">&#39;</span><span style="color: #C3E88D">error</span><span style="color: #89DDFF">&#39;</span><span style="color: #89DDFF">,</span><span style="color: #F07178"> </span><span style="color: #89DDFF">(</span><span style="color: #EEFFFF; font-style: italic">e</span><span style="color: #89DDFF">)</span><span style="color: #F07178"> </span><span style="color: #C792EA">=&gt;</span><span style="color: #F07178"> </span><span style="color: #89DDFF">{</span></span>
<span class="line"><span style="color: #89DDFF">    </span><span style="color: #546E7A; font-style: italic">// @ts-ignore</span></span>
<span class="line"><span style="color: #F07178">    </span><span style="color: #EEFFFF">e</span><span style="color: #89DDFF">.</span><span style="color: #EEFFFF">code</span><span style="color: #F07178"> </span><span style="color: #89DDFF">===</span><span style="color: #F07178"> </span><span style="color: #89DDFF">&#39;</span><span style="color: #C3E88D">EADDRINUSE</span><span style="color: #89DDFF">&#39;</span><span style="color: #F07178"> </span><span style="color: #89DDFF">&amp;&amp;</span><span style="color: #F07178"> </span><span style="color: #EEFFFF">console</span><span style="color: #89DDFF">.</span><span style="color: #82AAFF">error</span><span style="color: #F07178">(</span><span style="color: #89DDFF">&#39;</span><span style="color: #C3E88D">port: 4936 is used</span><span style="color: #89DDFF">&#39;</span><span style="color: #F07178">)</span></span>
<span class="line"><span style="color: #F07178">  </span><span style="color: #89DDFF">}</span><span style="color: #F07178">)</span></span>
<span class="line"><span style="color: #89DDFF">}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #546E7A; font-style: italic">/**</span></span>
<span class="line"><span style="color: #546E7A; font-style: italic"> * </span><span style="color: #89DDFF; font-style: italic">@</span><span style="color: #C792EA; font-style: italic">param</span><span style="color: #546E7A; font-style: italic"> </span><span style="color: #89DDFF; font-style: italic">{</span><span style="color: #FFCB6B; font-style: italic">import(&#39;vue&#39;).App&lt;any&gt; | import(&#39;vue&#39;).VNode</span><span style="color: #89DDFF; font-style: italic">}</span><span style="color: #546E7A; font-style: italic"> </span><span style="color: #EEFFFF; font-style: italic">root</span></span>
<span class="line"><span style="color: #546E7A; font-style: italic"> * </span><span style="color: #89DDFF; font-style: italic">@</span><span style="color: #C792EA; font-style: italic">returns</span><span style="color: #546E7A; font-style: italic"> </span><span style="color: #89DDFF; font-style: italic">{</span><span style="color: #FFCB6B; font-style: italic">Promise&lt;string&gt;</span><span style="color: #89DDFF; font-style: italic">}</span></span>
<span class="line"><span style="color: #546E7A; font-style: italic"> */</span></span>
<span class="line"><span style="color: #C792EA">async</span><span style="color: #EEFFFF"> </span><span style="color: #C792EA">function</span><span style="color: #EEFFFF"> </span><span style="color: #82AAFF">render</span><span style="color: #89DDFF">(</span><span style="color: #EEFFFF; font-style: italic">root</span><span style="color: #89DDFF">)</span><span style="color: #EEFFFF"> </span><span style="color: #89DDFF">{</span><span style="color: #546E7A; font-style: italic">/* ... */</span><span style="color: #89DDFF">}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #546E7A; font-style: italic">/**</span></span>
<span class="line"><span style="color: #546E7A; font-style: italic"> * </span><span style="color: #89DDFF; font-style: italic">@</span><span style="color: #C792EA; font-style: italic">desc</span><span style="color: #546E7A; font-style: italic"> 静态资源服务</span></span>
<span class="line"><span style="color: #546E7A; font-style: italic"> * </span><span style="color: #89DDFF; font-style: italic">@</span><span style="color: #C792EA; font-style: italic">param</span><span style="color: #546E7A; font-style: italic"> </span><span style="color: #89DDFF; font-style: italic">{</span><span style="color: #FFCB6B; font-style: italic">string</span><span style="color: #89DDFF; font-style: italic">}</span><span style="color: #546E7A; font-style: italic"> </span><span style="color: #EEFFFF; font-style: italic">filePath</span><span style="color: #546E7A; font-style: italic"> 文件路径</span></span>
<span class="line"><span style="color: #546E7A; font-style: italic"> * </span><span style="color: #89DDFF; font-style: italic">@</span><span style="color: #C792EA; font-style: italic">param</span><span style="color: #546E7A; font-style: italic"> </span><span style="color: #89DDFF; font-style: italic">{</span><span style="color: #FFCB6B; font-style: italic">import(&#39;node:http&#39;).ServerResponse</span><span style="color: #89DDFF; font-style: italic">}</span><span style="color: #546E7A; font-style: italic"> </span><span style="color: #EEFFFF; font-style: italic">res</span></span>
<span class="line"><span style="color: #546E7A; font-style: italic"> */</span></span>
<span class="line"><span style="color: #C792EA">async</span><span style="color: #EEFFFF"> </span><span style="color: #C792EA">function</span><span style="color: #EEFFFF"> </span><span style="color: #82AAFF">staticService</span><span style="color: #89DDFF">(</span><span style="color: #EEFFFF; font-style: italic">filePath</span><span style="color: #89DDFF">,</span><span style="color: #EEFFFF"> </span><span style="color: #EEFFFF; font-style: italic">res</span><span style="color: #89DDFF">)</span><span style="color: #EEFFFF"> </span><span style="color: #89DDFF">{</span></span>
<span class="line"><span style="color: #F07178">  </span><span style="color: #EEFFFF">filePath</span><span style="color: #F07178"> </span><span style="color: #89DDFF">=</span><span style="color: #F07178"> </span><span style="color: #82AAFF">fileURLToPath</span><span style="color: #F07178">(</span><span style="color: #89DDFF">new</span><span style="color: #F07178"> </span><span style="color: #82AAFF">URL</span><span style="color: #F07178">(</span><span style="color: #89DDFF">`</span><span style="color: #C3E88D">..</span><span style="color: #89DDFF">${</span><span style="color: #EEFFFF">filePath</span><span style="color: #89DDFF">}`</span><span style="color: #89DDFF">,</span><span style="color: #F07178"> </span><span style="color: #89DDFF; font-style: italic">import</span><span style="color: #89DDFF">.</span><span style="color: #EEFFFF">meta</span><span style="color: #89DDFF">.</span><span style="color: #EEFFFF">url</span><span style="color: #F07178">))</span></span>
<span class="line"><span style="color: #F07178">  </span><span style="color: #C792EA">const</span><span style="color: #F07178"> </span><span style="color: #EEFFFF">extension</span><span style="color: #F07178"> </span><span style="color: #89DDFF">=</span><span style="color: #F07178"> </span><span style="color: #82AAFF">extname</span><span style="color: #F07178">(</span><span style="color: #EEFFFF">filePath</span><span style="color: #F07178">)</span><span style="color: #89DDFF">.</span><span style="color: #82AAFF">slice</span><span style="color: #F07178">(</span><span style="color: #F78C6C">1</span><span style="color: #F07178">)</span></span>
<span class="line"><span style="color: #F07178">  </span><span style="color: #C792EA">const</span><span style="color: #F07178"> </span><span style="color: #EEFFFF">contentType</span><span style="color: #F07178"> </span><span style="color: #89DDFF">=</span></span>
<span class="line"><span style="color: #F07178">    </span><span style="color: #89DDFF">{</span></span>
<span class="line"><span style="color: #F07178">      html</span><span style="color: #89DDFF">:</span><span style="color: #F07178"> </span><span style="color: #89DDFF">&#39;</span><span style="color: #C3E88D">text/html;charset=UTF-8</span><span style="color: #89DDFF">&#39;</span><span style="color: #89DDFF">,</span></span>
<span class="line"><span style="color: #F07178">      js</span><span style="color: #89DDFF">:</span><span style="color: #F07178"> </span><span style="color: #89DDFF">&#39;</span><span style="color: #C3E88D">text/javascript;charset=UTF-8</span><span style="color: #89DDFF">&#39;</span><span style="color: #89DDFF">,</span></span>
<span class="line"><span style="color: #F07178">      css</span><span style="color: #89DDFF">:</span><span style="color: #F07178"> </span><span style="color: #89DDFF">&#39;</span><span style="color: #C3E88D">text/css;charset=UTF-8</span><span style="color: #89DDFF">&#39;</span><span style="color: #89DDFF">,</span></span>
<span class="line"><span style="color: #F07178">      png</span><span style="color: #89DDFF">:</span><span style="color: #F07178"> </span><span style="color: #89DDFF">&#39;</span><span style="color: #C3E88D">image/png</span><span style="color: #89DDFF">&#39;</span><span style="color: #89DDFF">,</span></span>
<span class="line"><span style="color: #F07178">      jpg</span><span style="color: #89DDFF">:</span><span style="color: #F07178"> </span><span style="color: #89DDFF">&#39;</span><span style="color: #C3E88D">image/jpeg</span><span style="color: #89DDFF">&#39;</span><span style="color: #89DDFF">,</span></span>
<span class="line"><span style="color: #F07178">      json</span><span style="color: #89DDFF">:</span><span style="color: #F07178"> </span><span style="color: #89DDFF">&#39;</span><span style="color: #C3E88D">application/json;charset=UTF-8</span><span style="color: #89DDFF">&#39;</span><span style="color: #89DDFF">,</span></span>
<span class="line"><span style="color: #F07178">      ico</span><span style="color: #89DDFF">:</span><span style="color: #F07178"> </span><span style="color: #89DDFF">&#39;</span><span style="color: #C3E88D">image/x-icon</span><span style="color: #89DDFF">&#39;</span><span style="color: #89DDFF">,</span></span>
<span class="line"><span style="color: #F07178">      svg</span><span style="color: #89DDFF">:</span><span style="color: #F07178"> </span><span style="color: #89DDFF">&#39;</span><span style="color: #C3E88D">image/svg+xml</span><span style="color: #89DDFF">&#39;</span><span style="color: #89DDFF">,</span></span>
<span class="line"><span style="color: #F07178">    </span><span style="color: #89DDFF">}</span><span style="color: #F07178">[</span><span style="color: #EEFFFF">extension</span><span style="color: #F07178">] </span><span style="color: #89DDFF">??</span><span style="color: #F07178"> </span><span style="color: #89DDFF">&#39;</span><span style="color: #C3E88D">text/plain;charset=UTF-8</span><span style="color: #89DDFF">&#39;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #F07178">  </span><span style="color: #89DDFF; font-style: italic">try</span><span style="color: #F07178"> </span><span style="color: #89DDFF">{</span></span>
<span class="line"><span style="color: #F07178">    </span><span style="color: #C792EA">const</span><span style="color: #F07178"> </span><span style="color: #EEFFFF">fileStat</span><span style="color: #F07178"> </span><span style="color: #89DDFF">=</span><span style="color: #F07178"> </span><span style="color: #89DDFF; font-style: italic">await</span><span style="color: #F07178"> </span><span style="color: #82AAFF">stat</span><span style="color: #F07178">(</span><span style="color: #EEFFFF">filePath</span><span style="color: #F07178">)</span></span>
<span class="line"><span style="color: #F07178">    </span><span style="color: #89DDFF; font-style: italic">if</span><span style="color: #F07178"> (</span><span style="color: #EEFFFF">fileStat</span><span style="color: #89DDFF">.</span><span style="color: #82AAFF">isFile</span><span style="color: #F07178">()) </span><span style="color: #89DDFF">{</span></span>
<span class="line"><span style="color: #F07178">      </span><span style="color: #EEFFFF">res</span><span style="color: #89DDFF">.</span><span style="color: #EEFFFF">statusCode</span><span style="color: #F07178"> </span><span style="color: #89DDFF">=</span><span style="color: #F07178"> </span><span style="color: #F78C6C">200</span></span>
<span class="line"><span style="color: #F07178">      </span><span style="color: #EEFFFF">res</span><span style="color: #89DDFF">.</span><span style="color: #82AAFF">setHeader</span><span style="color: #F07178">(</span><span style="color: #89DDFF">&#39;</span><span style="color: #C3E88D">Content-Type</span><span style="color: #89DDFF">&#39;</span><span style="color: #89DDFF">,</span><span style="color: #F07178"> </span><span style="color: #EEFFFF">contentType</span><span style="color: #F07178">)</span></span>
<span class="line"><span style="color: #F07178">      </span><span style="color: #82AAFF">createReadStream</span><span style="color: #F07178">(</span><span style="color: #EEFFFF">filePath</span><span style="color: #F07178">)</span><span style="color: #89DDFF">.</span><span style="color: #82AAFF">pipe</span><span style="color: #F07178">(</span><span style="color: #EEFFFF">res</span><span style="color: #F07178">)</span></span>
<span class="line"><span style="color: #F07178">    </span><span style="color: #89DDFF">}</span></span>
<span class="line"><span style="color: #F07178">  </span><span style="color: #89DDFF">}</span><span style="color: #F07178"> </span><span style="color: #89DDFF; font-style: italic">catch</span><span style="color: #F07178"> (</span><span style="color: #EEFFFF">e</span><span style="color: #F07178">) </span><span style="color: #89DDFF">{</span></span>
<span class="line"><span style="color: #F07178">    </span><span style="color: #EEFFFF">res</span><span style="color: #89DDFF">.</span><span style="color: #EEFFFF">statusCode</span><span style="color: #F07178"> </span><span style="color: #89DDFF">=</span><span style="color: #F07178"> </span><span style="color: #F78C6C">404</span></span>
<span class="line"><span style="color: #F07178">    </span><span style="color: #EEFFFF">res</span><span style="color: #89DDFF">.</span><span style="color: #82AAFF">end</span><span style="color: #F07178">()</span></span>
<span class="line"><span style="color: #F07178">  </span><span style="color: #89DDFF">}</span></span>
<span class="line"><span style="color: #89DDFF">}</span></span></code></pre>
</code></pre><p class="paragraph"><a name="wXux4"></a></p>
          <h3 id="CSS%E4%B8%8E%E5%9B%BE%E7%89%87%E8%B5%84%E6%BA%90" class="header h3">
            <a name="CSS与图片资源" data-level="3" class="anchor" href="#CSS%E4%B8%8E%E5%9B%BE%E7%89%87%E8%B5%84%E6%BA%90">
              <span class="header-link">#</span>
            </a>
            CSS与图片资源
          </h3><p class="paragraph">原先打算为了轻量而不使用<code class="inline-code">vite</code>的，但<code class="inline-code">esbuild</code>的<code class="inline-code">css</code>打包<code class="inline-code">spliting</code>选项功能太少了，而且会在每个引入有<code class="inline-code">css</code>的组件的文件处都生成一份样式文件使打包结果比较混乱，在打包后生成的<code class="inline-code">metafile</code>中也难以精确的知道是哪个组件需要样式文件只能全局引入。</p><p class="paragraph">而<code class="inline-code">rollup</code>或<code class="inline-code">rspack</code>暂时不能开箱即用需要一些插件支持，所以还是决定使用<code class="inline-code">vite</code>来进行打包，所以，现在<code class="inline-code">css</code>与图片资源与使用<code class="inline-code">vite</code>的应用一样了都由<code class="inline-code">vite</code>来托管了😅(包括动态的导入所需的静态资源也已经自动注入了<code class="inline-code">profill</code>与<code class="inline-code">vitePreload</code>函数来处理，这就是开箱即用的魅力吧)。<code class="inline-code">vite</code>服务端热更新在官网文档有介绍，这里先只关注于服务端渲染的实现，所以没有处理开发环境，只处理生产环境，需要打包后再预览。</p><pre><code class="language-bash"><pre class="shiki material-theme" style="background-color: #263238" tabindex="0"><code><span class="line"><span style="color: #FFCB6B">pnpm</span><span style="color: #EEFFFF"> </span><span style="color: #C3E88D">i</span><span style="color: #EEFFFF"> </span><span style="color: #C3E88D">vite</span><span style="color: #EEFFFF"> </span><span style="color: #C3E88D">-D</span></span>
<span class="line"><span style="color: #FFCB6B">pnpm</span><span style="color: #EEFFFF"> </span><span style="color: #C3E88D">rm</span><span style="color: #EEFFFF"> </span><span style="color: #C3E88D">esbuild</span><span style="color: #EEFFFF"> </span><span style="color: #C3E88D">-D</span></span></code></pre>
</code></pre><p class="paragraph">下面是<code class="inline-code">vite</code>客户端打包配置，为了方便仓库打包产物，这里把<code class="inline-code">target</code>设为<code class="inline-code">es2022</code>并关闭产物压缩。</p><pre><code class="language-javascript"><pre class="shiki material-theme" style="background-color: #263238" tabindex="0"><code><span class="line"><span style="color: #89DDFF; font-style: italic">import</span><span style="color: #EEFFFF"> </span><span style="color: #89DDFF">{</span><span style="color: #F07178"> </span><span style="color: #EEFFFF">defineConfig</span><span style="color: #F07178"> </span><span style="color: #89DDFF">}</span><span style="color: #EEFFFF"> </span><span style="color: #89DDFF; font-style: italic">from</span><span style="color: #EEFFFF"> </span><span style="color: #89DDFF">&#39;</span><span style="color: #C3E88D">vite</span><span style="color: #89DDFF">&#39;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #89DDFF; font-style: italic">export</span><span style="color: #EEFFFF"> </span><span style="color: #89DDFF; font-style: italic">default</span><span style="color: #EEFFFF"> </span><span style="color: #82AAFF">defineConfig</span><span style="color: #EEFFFF">(</span><span style="color: #89DDFF">{</span></span>
<span class="line"><span style="color: #EEFFFF">  </span><span style="color: #F07178">base</span><span style="color: #89DDFF">:</span><span style="color: #EEFFFF"> </span><span style="color: #89DDFF">&#39;</span><span style="color: #C3E88D">./</span><span style="color: #89DDFF">&#39;</span><span style="color: #89DDFF">,</span></span>
<span class="line"><span style="color: #EEFFFF">  </span><span style="color: #F07178">build</span><span style="color: #89DDFF">:</span><span style="color: #EEFFFF"> </span><span style="color: #89DDFF">{</span></span>
<span class="line"><span style="color: #EEFFFF">    </span><span style="color: #F07178">target</span><span style="color: #89DDFF">:</span><span style="color: #EEFFFF"> [</span><span style="color: #89DDFF">&#39;</span><span style="color: #C3E88D">es2022</span><span style="color: #89DDFF">&#39;</span><span style="color: #EEFFFF">]</span><span style="color: #89DDFF">,</span></span>
<span class="line"><span style="color: #EEFFFF">    </span><span style="color: #F07178">minify</span><span style="color: #89DDFF">:</span><span style="color: #EEFFFF"> </span><span style="color: #FF9CAC">false</span><span style="color: #89DDFF">,</span></span>
<span class="line"><span style="color: #EEFFFF">  </span><span style="color: #89DDFF">},</span></span>
<span class="line"><span style="color: #EEFFFF">  </span><span style="color: #F07178">css</span><span style="color: #89DDFF">:</span><span style="color: #EEFFFF"> </span><span style="color: #89DDFF">{</span></span>
<span class="line"><span style="color: #EEFFFF">    </span><span style="color: #F07178">modules</span><span style="color: #89DDFF">:</span><span style="color: #EEFFFF"> </span><span style="color: #89DDFF">{</span></span>
<span class="line"><span style="color: #EEFFFF">      </span><span style="color: #F07178">localsConvention</span><span style="color: #89DDFF">:</span><span style="color: #EEFFFF"> </span><span style="color: #89DDFF">&#39;</span><span style="color: #C3E88D">camelCase</span><span style="color: #89DDFF">&#39;</span><span style="color: #89DDFF">,</span></span>
<span class="line"><span style="color: #EEFFFF">      </span><span style="color: #F07178">scopeBehaviour</span><span style="color: #89DDFF">:</span><span style="color: #EEFFFF"> </span><span style="color: #89DDFF">&#39;</span><span style="color: #C3E88D">local</span><span style="color: #89DDFF">&#39;</span><span style="color: #89DDFF">,</span></span>
<span class="line"><span style="color: #EEFFFF">      </span><span style="color: #F07178">generateScopedName</span><span style="color: #89DDFF">:</span><span style="color: #EEFFFF"> </span><span style="color: #89DDFF">&#39;</span><span style="color: #C3E88D">[name]_[local]_[hash:5]</span><span style="color: #89DDFF">&#39;</span><span style="color: #89DDFF">,</span></span>
<span class="line"><span style="color: #EEFFFF">    </span><span style="color: #89DDFF">},</span></span>
<span class="line"><span style="color: #EEFFFF">  </span><span style="color: #89DDFF">},</span></span>
<span class="line"><span style="color: #89DDFF">}</span><span style="color: #EEFFFF">)</span></span>
<span class="line"></span></code></pre>
</code></pre><p class="paragraph">将<code class="inline-code">html</code>引入的文件改为<code class="inline-code">src/entry-client</code>由<code class="inline-code">vite</code>控制打包后的资源请求目录。</p><pre><code class="language-html"><pre class="shiki material-theme" style="background-color: #263238" tabindex="0"><code><span class="line"><span style="color: #89DDFF">&lt;!</span><span style="color: #F07178">DOCTYPE</span><span style="color: #89DDFF"> </span><span style="color: #C792EA">html</span><span style="color: #89DDFF">&gt;</span></span>
<span class="line"><span style="color: #89DDFF">&lt;</span><span style="color: #F07178">html</span><span style="color: #89DDFF"> </span><span style="color: #C792EA">lang</span><span style="color: #89DDFF">=</span><span style="color: #89DDFF">&quot;</span><span style="color: #C3E88D">zh</span><span style="color: #89DDFF">&quot;</span><span style="color: #89DDFF">&gt;</span></span>
<span class="line"><span style="color: #EEFFFF">  </span><span style="color: #89DDFF">&lt;</span><span style="color: #F07178">head</span><span style="color: #89DDFF">&gt;</span></span>
<span class="line"><span style="color: #EEFFFF">    </span><span style="color: #546E7A; font-style: italic">&lt;!-- ... --&gt;</span></span>
<span class="line"><span style="color: #89DDFF">    &lt;</span><span style="color: #F07178">script</span><span style="color: #89DDFF"> </span><span style="color: #C792EA">type</span><span style="color: #89DDFF">=</span><span style="color: #89DDFF">&quot;</span><span style="color: #C3E88D">module</span><span style="color: #89DDFF">&quot;</span><span style="color: #89DDFF"> </span><span style="color: #C792EA">src</span><span style="color: #89DDFF">=</span><span style="color: #89DDFF">&quot;</span><span style="color: #C3E88D">src/entry-client.js</span><span style="color: #89DDFF">&quot;</span><span style="color: #89DDFF"> &gt;&lt;/</span><span style="color: #F07178">script</span><span style="color: #89DDFF">&gt;    </span></span>
<span class="line"><span style="color: #EEFFFF">    </span><span style="color: #546E7A; font-style: italic">&lt;!-- Head Slot --&gt;</span></span>
<span class="line"><span style="color: #EEFFFF">  </span><span style="color: #89DDFF">&lt;/</span><span style="color: #F07178">head</span><span style="color: #89DDFF">&gt;</span></span>
<span class="line"><span style="color: #EEFFFF">  </span><span style="color: #89DDFF">&lt;</span><span style="color: #F07178">body</span><span style="color: #89DDFF">&gt;</span></span>
<span class="line"><span style="color: #EEFFFF">    </span><span style="color: #89DDFF">&lt;</span><span style="color: #F07178">div</span><span style="color: #89DDFF"> </span><span style="color: #C792EA">id</span><span style="color: #89DDFF">=</span><span style="color: #89DDFF">&quot;</span><span style="color: #C3E88D">app</span><span style="color: #89DDFF">&quot;</span><span style="color: #89DDFF">&gt;</span><span style="color: #546E7A; font-style: italic">&lt;!-- App Slot --&gt;</span><span style="color: #89DDFF">&lt;/</span><span style="color: #F07178">div</span><span style="color: #89DDFF">&gt;</span></span>
<span class="line"><span style="color: #EEFFFF">  </span><span style="color: #89DDFF">&lt;/</span><span style="color: #F07178">body</span><span style="color: #89DDFF">&gt;</span></span>
<span class="line"><span style="color: #89DDFF">&lt;/</span><span style="color: #F07178">html</span><span style="color: #89DDFF">&gt;</span></span>
<span class="line"></span></code></pre>
</code></pre><p class="paragraph">由于<code class="inline-code">node.js</code>引入<code class="inline-code">esm</code>需要添加额外的<code class="inline-code">.js</code>后缀很麻烦，所以对<code class="inline-code">entry-server.js</code>也进行打包处理。新建一个单独的<code class="inline-code">vite</code>配置文件用于打包服务端入口文件，将打包产物放到<code class="inline-code">dist/server</code>目录下，如此<code class="inline-code">entry-server.js</code>与 HTML 目标的相对位置与源码目录一致。</p><pre><code class="language-javascript"><pre class="shiki material-theme" style="background-color: #263238" tabindex="0"><code><span class="line"><span style="color: #89DDFF; font-style: italic">import</span><span style="color: #EEFFFF"> clientConfig </span><span style="color: #89DDFF; font-style: italic">from</span><span style="color: #EEFFFF"> </span><span style="color: #89DDFF">&#39;</span><span style="color: #C3E88D">./vite.config</span><span style="color: #89DDFF">&#39;</span></span>
<span class="line"><span style="color: #89DDFF; font-style: italic">import</span><span style="color: #EEFFFF"> </span><span style="color: #89DDFF">{</span><span style="color: #F07178"> </span><span style="color: #EEFFFF">defineConfig</span><span style="color: #89DDFF">,</span><span style="color: #F07178"> </span><span style="color: #EEFFFF">mergeConfig</span><span style="color: #F07178"> </span><span style="color: #89DDFF">}</span><span style="color: #EEFFFF"> </span><span style="color: #89DDFF; font-style: italic">from</span><span style="color: #EEFFFF"> </span><span style="color: #89DDFF">&#39;</span><span style="color: #C3E88D">vite</span><span style="color: #89DDFF">&#39;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #89DDFF; font-style: italic">export</span><span style="color: #EEFFFF"> </span><span style="color: #89DDFF; font-style: italic">default</span><span style="color: #EEFFFF"> </span><span style="color: #82AAFF">mergeConfig</span><span style="color: #EEFFFF">(</span></span>
<span class="line"><span style="color: #EEFFFF">  clientConfig</span><span style="color: #89DDFF">,</span></span>
<span class="line"><span style="color: #EEFFFF">  </span><span style="color: #82AAFF">defineConfig</span><span style="color: #EEFFFF">(</span><span style="color: #89DDFF">{</span></span>
<span class="line"><span style="color: #EEFFFF">    </span><span style="color: #F07178">build</span><span style="color: #89DDFF">:</span><span style="color: #EEFFFF"> </span><span style="color: #89DDFF">{</span></span>
<span class="line"><span style="color: #EEFFFF">      </span><span style="color: #F07178">outDir</span><span style="color: #89DDFF">:</span><span style="color: #EEFFFF"> </span><span style="color: #89DDFF">&#39;</span><span style="color: #C3E88D">dist/server</span><span style="color: #89DDFF">&#39;</span><span style="color: #89DDFF">,</span></span>
<span class="line"><span style="color: #EEFFFF">      </span><span style="color: #F07178">ssr</span><span style="color: #89DDFF">:</span><span style="color: #EEFFFF"> </span><span style="color: #89DDFF">&#39;</span><span style="color: #C3E88D">src/entry-server.js</span><span style="color: #89DDFF">&#39;</span><span style="color: #89DDFF">,</span></span>
<span class="line"><span style="color: #EEFFFF">      </span><span style="color: #F07178">ssrManifest</span><span style="color: #89DDFF">:</span><span style="color: #EEFFFF"> </span><span style="color: #FF9CAC">true</span><span style="color: #89DDFF">,</span></span>
<span class="line"><span style="color: #EEFFFF">    </span><span style="color: #89DDFF">},</span></span>
<span class="line"><span style="color: #EEFFFF">  </span><span style="color: #89DDFF">}</span><span style="color: #EEFFFF">)</span></span>
<span class="line"><span style="color: #EEFFFF">)</span></span>
<span class="line"></span></code></pre>
</code></pre><p class="paragraph">配置一下<code class="inline-code">package.json</code>脚本, <strong class="strong">注意要先打包</strong><code class="inline-code">**client**</code><strong class="strong">,再打包</strong><code class="inline-code">**server**</code><strong class="strong">否则</strong><code class="inline-code">**vite**</code><strong class="strong">会在生成客户端打包产物时把 dist 中的打包</strong><code class="inline-code">**server**</code><strong class="strong">目录清空</strong></p><pre><code class="language-json"><pre class="shiki material-theme" style="background-color: #263238" tabindex="0"><code><span class="line"><span style="color: #89DDFF">{</span></span>
<span class="line"><span style="color: #EEFFFF">  </span><span style="color: #89DDFF">&quot;</span><span style="color: #C792EA">type</span><span style="color: #89DDFF">&quot;</span><span style="color: #89DDFF">:</span><span style="color: #EEFFFF"> </span><span style="color: #89DDFF">&quot;</span><span style="color: #C3E88D">module</span><span style="color: #89DDFF">&quot;</span><span style="color: #89DDFF">,</span></span>
<span class="line"><span style="color: #EEFFFF">  </span><span style="color: #89DDFF">&quot;</span><span style="color: #C792EA">scripts</span><span style="color: #89DDFF">&quot;</span><span style="color: #89DDFF">:</span><span style="color: #EEFFFF"> </span><span style="color: #89DDFF">{</span></span>
<span class="line"><span style="color: #EEFFFF">    </span><span style="color: #89DDFF">&quot;</span><span style="color: #FFCB6B">build</span><span style="color: #89DDFF">&quot;</span><span style="color: #89DDFF">:</span><span style="color: #EEFFFF"> </span><span style="color: #89DDFF">&quot;</span><span style="color: #C3E88D">pnpm build:client &amp; pnpm build:server</span><span style="color: #89DDFF">&quot;</span><span style="color: #89DDFF">,</span></span>
<span class="line"><span style="color: #EEFFFF">    </span><span style="color: #89DDFF">&quot;</span><span style="color: #FFCB6B">build:client</span><span style="color: #89DDFF">&quot;</span><span style="color: #89DDFF">:</span><span style="color: #EEFFFF"> </span><span style="color: #89DDFF">&quot;</span><span style="color: #C3E88D">vite build</span><span style="color: #89DDFF">&quot;</span><span style="color: #89DDFF">,</span></span>
<span class="line"><span style="color: #EEFFFF">    </span><span style="color: #89DDFF">&quot;</span><span style="color: #FFCB6B">build:server</span><span style="color: #89DDFF">&quot;</span><span style="color: #89DDFF">:</span><span style="color: #EEFFFF"> </span><span style="color: #89DDFF">&quot;</span><span style="color: #C3E88D">vite build -c ./vite.config.server.js </span><span style="color: #89DDFF">&quot;</span><span style="color: #89DDFF">,</span></span>
<span class="line"><span style="color: #EEFFFF">    </span><span style="color: #89DDFF">&quot;</span><span style="color: #FFCB6B">dev</span><span style="color: #89DDFF">&quot;</span><span style="color: #89DDFF">:</span><span style="color: #EEFFFF"> </span><span style="color: #89DDFF">&quot;</span><span style="color: #C3E88D">pnpm build &amp;&amp; node ./dist/server/entry-server.js</span><span style="color: #89DDFF">&quot;</span><span style="color: #89DDFF">,</span></span>
<span class="line"><span style="color: #EEFFFF">    </span><span style="color: #89DDFF">&quot;</span><span style="color: #FFCB6B">preview</span><span style="color: #89DDFF">&quot;</span><span style="color: #89DDFF">:</span><span style="color: #EEFFFF"> </span><span style="color: #89DDFF">&quot;</span><span style="color: #C3E88D">node ./dist/server/entry-server.js</span><span style="color: #89DDFF">&quot;</span></span>
<span class="line"><span style="color: #EEFFFF">  </span><span style="color: #89DDFF">},</span></span>
<span class="line"><span style="color: #EEFFFF">  </span><span style="color: #89DDFF">&quot;</span><span style="color: #C792EA">dependencies</span><span style="color: #89DDFF">&quot;</span><span style="color: #89DDFF">:</span><span style="color: #EEFFFF"> </span><span style="color: #89DDFF">{</span></span>
<span class="line"><span style="color: #EEFFFF">    </span><span style="color: #89DDFF">&quot;</span><span style="color: #FFCB6B">vue</span><span style="color: #89DDFF">&quot;</span><span style="color: #89DDFF">:</span><span style="color: #EEFFFF"> </span><span style="color: #89DDFF">&quot;</span><span style="color: #C3E88D">^3.3.7</span><span style="color: #89DDFF">&quot;</span><span style="color: #89DDFF">,</span></span>
<span class="line"><span style="color: #EEFFFF">  </span><span style="color: #89DDFF">},</span></span>
<span class="line"><span style="color: #EEFFFF">  </span><span style="color: #89DDFF">&quot;</span><span style="color: #C792EA">devDependencies</span><span style="color: #89DDFF">&quot;</span><span style="color: #89DDFF">:</span><span style="color: #EEFFFF"> </span><span style="color: #89DDFF">{</span></span>
<span class="line"><span style="color: #EEFFFF">    </span><span style="color: #89DDFF">&quot;</span><span style="color: #FFCB6B">@types/node</span><span style="color: #89DDFF">&quot;</span><span style="color: #89DDFF">:</span><span style="color: #EEFFFF"> </span><span style="color: #89DDFF">&quot;</span><span style="color: #C3E88D">^20.8.9</span><span style="color: #89DDFF">&quot;</span><span style="color: #89DDFF">,</span></span>
<span class="line"><span style="color: #EEFFFF">    </span><span style="color: #89DDFF">&quot;</span><span style="color: #FFCB6B">vite</span><span style="color: #89DDFF">&quot;</span><span style="color: #89DDFF">:</span><span style="color: #EEFFFF"> </span><span style="color: #89DDFF">&quot;</span><span style="color: #C3E88D">^4.5.0</span><span style="color: #89DDFF">&quot;</span></span>
<span class="line"><span style="color: #EEFFFF">  </span><span style="color: #89DDFF">}</span></span>
<span class="line"><span style="color: #89DDFF">}</span></span>
<span class="line"></span></code></pre>
</code></pre><p class="paragraph">重构一下<code class="inline-code">entry-server.js</code>的代码可以把<code class="inline-code">.js</code>后缀去除了。</p><pre><code class="language-javascript"><pre class="shiki material-theme" style="background-color: #263238" tabindex="0"><code><span class="line"><span style="color: #546E7A; font-style: italic">// import ...</span></span>
<span class="line"></span>
<span class="line"><span style="color: #546E7A; font-style: italic">// 可以把 `.js` 后缀去除了</span></span>
<span class="line"><span style="color: #89DDFF; font-style: italic">import</span><span style="color: #EEFFFF"> createApp </span><span style="color: #89DDFF; font-style: italic">from</span><span style="color: #EEFFFF"> </span><span style="color: #89DDFF">&#39;</span><span style="color: #C3E88D">./App</span><span style="color: #89DDFF">&#39;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #546E7A; font-style: italic">// ...</span></span></code></pre>
</code></pre><p class="paragraph"><a name="bQDS8"></a></p>
          <h3 id="%E8%B5%84%E6%BA%90preload" class="header h3">
            <a name="资源preload" data-level="3" class="anchor" href="#%E8%B5%84%E6%BA%90preload">
              <span class="header-link">#</span>
            </a>
            资源preload
          </h3><p class="paragraph">该部分与打包工具关联性较强，<code class="inline-code">vite</code>默认在客户端打包产物中自动添加<code class="inline-code">preload</code>相关的<code class="inline-code">js</code>代码。<br />🚧WIP</p><p class="paragraph"><a name="gSUBL"></a></p>
          <h2 id="%E4%BC%98%E5%8C%96" class="header h2">
            <a name="优化" data-level="2" class="anchor" href="#%E4%BC%98%E5%8C%96">
              <span class="header-link">#</span>
            </a>
            优化
          </h2><p class="paragraph"><a name="ofSz5"></a></p>
          <h3 id="%E5%9F%BA%E4%BA%8ESSR%E9%A2%84%E6%B8%B2%E6%9F%93" class="header h3">
            <a name="基于SSR预渲染" data-level="3" class="anchor" href="#%E5%9F%BA%E4%BA%8ESSR%E9%A2%84%E6%B8%B2%E6%9F%93">
              <span class="header-link">#</span>
            </a>
            基于SSR预渲染
          </h3><p class="paragraph">对于长时间的不会更新的路由可以在构建阶段直接生成 HTML 后保存为静态资源，服务端判定路由为预渲染路由则直接返回对应的静态资源，亦可使用 Nginx 配置路径的转发。<br />新建<code class="inline-code">entry-prerender.js</code>用于在构建阶段对特定路由预渲染。</p><pre><code class="language-javascript"><pre class="shiki material-theme" style="background-color: #263238" tabindex="0"><code><span class="line"><span style="color: #89DDFF; font-style: italic">import</span><span style="color: #EEFFFF"> </span><span style="color: #89DDFF">{</span><span style="color: #F07178"> </span><span style="color: #EEFFFF">readFile</span><span style="color: #F07178"> </span><span style="color: #89DDFF">}</span><span style="color: #EEFFFF"> </span><span style="color: #89DDFF; font-style: italic">from</span><span style="color: #EEFFFF"> </span><span style="color: #89DDFF">&#39;</span><span style="color: #C3E88D">node:fs/promises</span><span style="color: #89DDFF">&#39;</span></span>
<span class="line"><span style="color: #89DDFF; font-style: italic">import</span><span style="color: #EEFFFF"> </span><span style="color: #89DDFF">{</span><span style="color: #F07178"> </span><span style="color: #EEFFFF">fileURLToPath</span><span style="color: #89DDFF">,</span><span style="color: #F07178"> </span><span style="color: #EEFFFF">resolve</span><span style="color: #F07178"> </span><span style="color: #89DDFF">}</span><span style="color: #EEFFFF"> </span><span style="color: #89DDFF; font-style: italic">from</span><span style="color: #EEFFFF"> </span><span style="color: #89DDFF">&#39;</span><span style="color: #C3E88D">node:path</span><span style="color: #89DDFF">&#39;</span><span style="color: #EEFFFF"> </span></span>
<span class="line"></span>
<span class="line"><span style="color: #89DDFF; font-style: italic">import</span><span style="color: #EEFFFF"> </span><span style="color: #89DDFF">{</span><span style="color: #F07178"> </span><span style="color: #EEFFFF">render</span><span style="color: #F07178"> </span><span style="color: #89DDFF">}</span><span style="color: #EEFFFF"> </span><span style="color: #89DDFF; font-style: italic">from</span><span style="color: #EEFFFF"> </span><span style="color: #89DDFF">&#39;</span><span style="color: #C3E88D">./entry-server.js</span><span style="color: #89DDFF">&#39;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C792EA">const</span><span style="color: #EEFFFF"> distPath </span><span style="color: #89DDFF">=</span><span style="color: #EEFFFF"> </span><span style="color: #82AAFF">fileURLToPath</span><span style="color: #EEFFFF">(</span><span style="color: #89DDFF">new</span><span style="color: #EEFFFF"> </span><span style="color: #82AAFF">URL</span><span style="color: #EEFFFF">(</span><span style="color: #89DDFF">&#39;</span><span style="color: #C3E88D">..</span><span style="color: #89DDFF">&#39;</span><span style="color: #89DDFF">,</span><span style="color: #EEFFFF"> </span><span style="color: #89DDFF; font-style: italic">import</span><span style="color: #89DDFF">.</span><span style="color: #EEFFFF">meta</span><span style="color: #89DDFF">.</span><span style="color: #EEFFFF">url))</span></span>
<span class="line"></span>
<span class="line"><span style="color: #546E7A; font-style: italic">/**</span></span>
<span class="line"><span style="color: #546E7A; font-style: italic">    * </span><span style="color: #89DDFF; font-style: italic">@</span><span style="color: #C792EA; font-style: italic">params</span><span style="color: #546E7A; font-style: italic"> {string[]} 需要预渲染的路由</span></span>
<span class="line"><span style="color: #546E7A; font-style: italic">    */</span></span>
<span class="line"><span style="color: #C792EA">async</span><span style="color: #EEFFFF"> </span><span style="color: #C792EA">function</span><span style="color: #EEFFFF"> </span><span style="color: #82AAFF">startPrerender</span><span style="color: #89DDFF">(</span><span style="color: #EEFFFF; font-style: italic">routes</span><span style="color: #89DDFF">)</span><span style="color: #EEFFFF"> </span><span style="color: #89DDFF">{</span></span>
<span class="line"><span style="color: #F07178">  </span><span style="color: #EEFFFF">routes</span><span style="color: #F07178"> </span><span style="color: #89DDFF">=</span><span style="color: #F07178"> [</span><span style="color: #89DDFF">...new</span><span style="color: #F07178"> </span><span style="color: #82AAFF">Set</span><span style="color: #F07178">(</span><span style="color: #89DDFF">...</span><span style="color: #EEFFFF">routes</span><span style="color: #89DDFF">.</span><span style="color: #82AAFF">map</span><span style="color: #F07178">(</span><span style="color: #EEFFFF">cleanRouteMap</span><span style="color: #F07178">)]</span></span>
<span class="line"><span style="color: #F07178">  </span></span>
<span class="line"><span style="color: #F07178">  </span><span style="color: #EEFFFF">routes</span><span style="color: #89DDFF">.</span><span style="color: #82AAFF">map</span><span style="color: #F07178">(</span><span style="color: #C792EA">async</span><span style="color: #F07178"> </span><span style="color: #89DDFF">(</span><span style="color: #EEFFFF; font-style: italic">route</span><span style="color: #89DDFF">)</span><span style="color: #F07178"> </span><span style="color: #C792EA">=&gt;</span><span style="color: #F07178"> </span><span style="color: #89DDFF">{</span></span>
<span class="line"><span style="color: #F07178">    </span><span style="color: #C792EA">const</span><span style="color: #F07178"> </span><span style="color: #EEFFFF">path</span><span style="color: #F07178"> </span><span style="color: #89DDFF">=</span><span style="color: #F07178"> </span><span style="color: #82AAFF">routeToFilePath</span><span style="color: #F07178">(</span><span style="color: #EEFFFF">route</span><span style="color: #F07178">)</span></span>
<span class="line"><span style="color: #F07178">    </span><span style="color: #C792EA">const</span><span style="color: #F07178"> </span><span style="color: #EEFFFF">page</span><span style="color: #F07178"> </span><span style="color: #89DDFF">=</span><span style="color: #F07178"> </span><span style="color: #89DDFF; font-style: italic">await</span><span style="color: #F07178"> </span><span style="color: #82AAFF">render</span><span style="color: #F07178">(</span><span style="color: #EEFFFF">route</span><span style="color: #F07178">)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #F07178">    </span><span style="color: #82AAFF">writeFile</span><span style="color: #F07178">(</span><span style="color: #EEFFFF">path</span><span style="color: #89DDFF">,</span><span style="color: #F07178"> </span><span style="color: #EEFFFF">page</span><span style="color: #F07178">)</span></span>
<span class="line"><span style="color: #F07178">  </span><span style="color: #89DDFF">}</span><span style="color: #F07178">)</span></span>
<span class="line"><span style="color: #F07178">}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C792EA">function</span><span style="color: #F07178"> </span><span style="color: #82AAFF">cleanRouteMap</span><span style="color: #89DDFF">(</span><span style="color: #EEFFFF; font-style: italic">route</span><span style="color: #89DDFF">)</span><span style="color: #F07178"> </span><span style="color: #89DDFF">{</span></span>
<span class="line"><span style="color: #F07178">  </span><span style="color: #EEFFFF">route</span><span style="color: #F07178"> </span><span style="color: #89DDFF">=</span><span style="color: #F07178"> </span><span style="color: #EEFFFF">route</span><span style="color: #F07178">[</span><span style="color: #F78C6C">0</span><span style="color: #F07178">] </span><span style="color: #89DDFF">===</span><span style="color: #F07178"> </span><span style="color: #89DDFF">&#39;</span><span style="color: #C3E88D">/</span><span style="color: #89DDFF">&#39;</span><span style="color: #F07178"> </span><span style="color: #89DDFF">?</span><span style="color: #F07178"> </span><span style="color: #EEFFFF">route</span><span style="color: #F07178"> </span><span style="color: #89DDFF">:</span><span style="color: #F07178"> </span><span style="color: #89DDFF">&#39;</span><span style="color: #C3E88D">/</span><span style="color: #89DDFF">&#39;</span><span style="color: #F07178"> </span><span style="color: #89DDFF">+</span><span style="color: #F07178"> </span><span style="color: #EEFFFF">route</span><span style="color: #F07178">)</span></span>
<span class="line"><span style="color: #F07178">  </span><span style="color: #89DDFF; font-style: italic">return</span><span style="color: #F07178"> </span><span style="color: #EEFFFF">route</span><span style="color: #89DDFF">.</span><span style="color: #82AAFF">at</span><span style="color: #F07178">(</span><span style="color: #89DDFF">-</span><span style="color: #F78C6C">1</span><span style="color: #F07178">) </span><span style="color: #89DDFF">===</span><span style="color: #F07178"> </span><span style="color: #89DDFF">&#39;</span><span style="color: #C3E88D">/</span><span style="color: #89DDFF">&#39;</span><span style="color: #F07178"> </span><span style="color: #89DDFF">?</span><span style="color: #F07178"> </span><span style="color: #EEFFFF">route</span><span style="color: #89DDFF">.</span><span style="color: #82AAFF">slice</span><span style="color: #F07178">(</span><span style="color: #F78C6C">0</span><span style="color: #89DDFF">,</span><span style="color: #F07178"> </span><span style="color: #89DDFF">-</span><span style="color: #F78C6C">1</span><span style="color: #F07178">) </span><span style="color: #89DDFF">:</span><span style="color: #F07178"> </span><span style="color: #EEFFFF">route</span><span style="color: #F07178">)</span></span>
<span class="line"><span style="color: #89DDFF">}</span></span>
<span class="line"></span></code></pre>
</code></pre><p class="paragraph">使用基于 <code class="inline-code">vite</code> 的 build API 进行静态资源的压缩处理与 sitemap 的生成。
<a name="r5YYB"></a></p>
          <h3 id="%E7%BC%93%E5%AD%98%E6%9C%8D%E5%8A%A1%E7%AB%AF%E6%B8%B2%E6%9F%93%E7%BB%93%E6%9E%9C" class="header h3">
            <a name="缓存服务端渲染结果" data-level="3" class="anchor" href="#%E7%BC%93%E5%AD%98%E6%9C%8D%E5%8A%A1%E7%AB%AF%E6%B8%B2%E6%9F%93%E7%BB%93%E6%9E%9C">
              <span class="header-link">#</span>
            </a>
            缓存服务端渲染结果
          </h3><p class="paragraph">对服务端的渲染结果进行
<a name="McfcZ"></a></p>
          <h3 id="Island" class="header h3">
            <a name="Island" data-level="3" class="anchor" href="#Island">
              <span class="header-link">#</span>
            </a>
            Island
          </h3><p class="paragraph"><a name="SjbSf"></a></p>
          <h2 id="%E5%8F%82%E8%80%83" class="header h2">
            <a name="参考" data-level="2" class="anchor" href="#%E5%8F%82%E8%80%83">
              <span class="header-link">#</span>
            </a>
            参考
          </h2><p class="paragraph"><a href="https://cn.vuejs.org/guide/scaling-up/ssr.html#server-side-rendering-ssr" title="null" class="link">服务端渲染 (SSR) | Vue.js</a><br /><a href="https://v2.ssr.vuejs.org/zh/" title="null" class="link">Vue.js 服务器端渲染指南 | Vue SSR 指南</a><br /><a href="https://pinia.vuejs.org/zh/ssr/" title="null" class="link">Pinia 🍍</a><br /><a href="https://vitejs.dev/guide/ssr" title="null" class="link">Vite</a></p>
          </article>

          <section class="bg-primary-2 mt-4 pa-4 rounded-xl dark:bg-primary-7 line-height-6">
            <h3 class="mt-0">评论</h3>
            <form id="comment" action="/api/comment" class="flex flex-col gap-4">
              <textarea
                id="comment-textarea"
                required
                placeholder="写下你的评论 (友善的评论是交流的起点)"
                text="base primary-7 dark:primary-1"
                bg="primary-1/50 hover:primary-1 focus:primary-50 dark:primary-6/50 dark:hover:primary-6 dark:focus:primary-8"
                class="pa-2 resize-y h-20 transition-background-color scrollbar-slim rounded border-none focus-visible:outline-none"
              ></textarea>
              <div class="flex justify-between">
                <input
                  id="comment-nickname"
                  type="text"
                  required
                  placeholder="请输入昵称"
                  text="base primary-7 dark:primary-1"
                  bg="primary-1/50 hover:primary-1 focus:primary-50 dark:primary-6/50 dark:hover:primary-6 dark:focus:primary-8"
                  class="pa-1 transition-background-color rounded border-none focus-visible:outline-none"
                />
                <button
                  id="comment-submit"
                  type="button"
                  bg="hover:primary-4/50 active:primary-3 primary-3 dark:hover:primary-5/50 dark:active:primary-5 dark:primary-5"
                  class="ml-auto border-none rounded font-bold py-2 px-4 transition-background-color"
                >
                  提交
                </button>
              </div>
            </form>

            <div id="comment-container" class="ml-2">
              <div class="flex items-start gap-4">
                <p class="flex flex-col items-center justify-center">
                  <span class="font-bold block h-4 w-10 bg-primary-3 dark:bg-primary-6 animate-paused"></span>
                </p>

                <p class="flex flex-1 flex-col bg-primary-3 dark:bg-primary-6 rounded pa-2 animate-paused">
                  <span class="block h-4"></span>
                  <span class="ml-auto text-sm block h-4 text-primary-5 dark:bg-primary-3"
                    ><time></time></span
                  >
                </p>
              </div>
            </div>
          </section>
        </main>
        <aside class="hidden md:block basis-72">
          <div class="sticky top-0">
            <nav>
              <ul>
                <li>11</li>
                <li>22</li>
                <li>33</li>
              </ul>
            </nav>
          </div>
        </aside>
      </div>
      <footer></footer>
    </div>
  </body>
</html>
